// ==UserScript==
// @name          YouTube去广告
// @namespace  AdGuard
// @version        1.0
// @description  去除YouTube广告
// @match        *://*.youtube.com/*
// @run-at       document-start
// ==/UserScript==

/* content-script - v2.0.4 - 3/1/2023 */
/* included @adguard/extended-css v2.0.51 */
(function() {
    'use strict';
(function(){var configuration={commonCss:"#offer-module, ytd-banner-promo-renderer, .ytd-compact-promoted-video-renderer, .ytp-ad-player-overlay-flyout-cta, ytd-search-pyv-renderer, .statement-banner-foreground-content, .ytd-merch-shelf-renderer, #player-ads, .ytd-action-companion-ad-renderer, ytm-promoted-sparkles-text-search-renderer, ytd-video-masthead-ad-v3-renderer, ytd-ad-slot-renderer, .promoted-sparkles-text-search-root-container, .ytd-video-masthead-ad-primary-video-overlay-renderer, ytd-compact-promoted-video-renderer, .ytd-search-pyv-renderer, .ad-showing > .html5-video-container, .ytd-player-legacy-desktop-watch-ads-renderer, #YtKevlarVisibilityIdentifier, .ytd-video-masthead-ad-v3-renderer, ytd-display-ad-renderer, #pla-shelf, ytd-single-option-survey-renderer, .ytd-promoted-sparkles-text-search-renderer, YTM-PROMOTED-VIDEO-RENDERER, ytd-promoted-sparkles-web-renderer, .ytd-promoted-video-renderer, .ytd-rich-item-renderer > ytd-ad-slot-renderer, .ytp-ad-progress, .ytd-carousel-ad-renderer, [layout*=\"display-ad-\"], ytd-promoted-sparkles-text-search-renderer, .ytd-in-feed-ad-layout-renderer, .ytp-ad-button, #masthead-ad, #merch-shelf, .ytd-ad-slot-renderer, .ytp-ad-progress-list, ytm-companion-slot, ytm-promoted-sparkles-web-renderer, .ytd-companion-slot-renderer { display: none!important; }\n",specificCss:null,extendedCssRules:["ytd-rich-item-renderer:-abp-has(ytd-display-ad-renderer) { display: none!important; }","ytd-rich-grid-renderer ytd-rich-item-renderer div > ytd-display-ad-renderer:upward(2) { display: none!important; }","#contents > ytd-rich-item-renderer:has( > #content > ytd-ad-slot-renderer) { display: none!important; }",],script:"(function setConstant(source,args){function noopFunc(){}function noopCallbackFunc(){return noopFunc}function trueFunc(){return!0}function falseFunc(){return!1}function throwFunc(){throw new Error}function noopPromiseReject(){return Promise.reject()}function noopPromiseResolve(){let responseBody=arguments.length>0&&void 0!==arguments[0]?arguments[0]:\"{}\",responseUrl=arguments.length>1&&void 0!==arguments[1]?arguments[1]:\"\",responseType=arguments.length>2&&void 0!==arguments[2]?arguments[2]:\"default\";if(\"undefined\"==typeof Response)return;const response=new Response(responseBody,{status:200,statusText:\"OK\"});return Object.defineProperties(response,{url:{value:responseUrl},type:{value:responseType}}),Promise.resolve(response)}function getPropertyInChain(base,chain){const pos=chain.indexOf(\".\");if(-1===pos)return{base:base,prop:chain};const prop=chain.slice(0,pos);if(null===base)return{base:base,prop:prop,chain:chain};const nextBase=base[prop];return chain=chain.slice(pos+1),(base instanceof Object||\"object\"==typeof base)&&isEmptyObject(base)||null===nextBase?{base:base,prop:prop,chain:chain}:void 0!==nextBase?getPropertyInChain(nextBase,chain):(Object.defineProperty(base,prop,{configurable:!0}),{base:base,prop:prop,chain:chain})}function isEmptyObject(obj){return 0===Object.keys(obj).length&&!obj.prototype}const updatedArgs=args?[].concat(source).concat(args):[source];try{(function(source,property,value,stack){if(!property||!function(stackMatch,stackTrace){if(!stackMatch||\"\"===stackMatch)return!0;if(function(stackMatch,stackTrace){const INLINE_SCRIPT_STRING=\"inlineScript\",INJECTED_SCRIPT_STRING=\"injectedScript\",INJECTED_SCRIPT_MARKER=\"<anonymous>\",isInlineScript=function(stackMatch){return stackMatch.indexOf(INLINE_SCRIPT_STRING)>-1},isInjectedScript=function(stackMatch){return stackMatch.indexOf(INJECTED_SCRIPT_STRING)>-1};if(!isInlineScript(stackMatch)&&!isInjectedScript(stackMatch))return!1;let documentURL=window.location.href;const pos=documentURL.indexOf(\"#\");-1!==pos&&(documentURL=documentURL.slice(0,pos));const stackLines=stackTrace.split(\"\\n\").slice(2).map((function(line){return line.trim()})).map((function(line){let stack;const getStackTraceURL=\/(.*?@)?(\\S+)(:\\d+):\\d+\\)?$\/.exec(line);if(getStackTraceURL){let stackURL=getStackTraceURL[2];if(startsWith(stackURL,\"(\")&&(stackURL=stackURL.slice(1)),startsWith(stackURL,INJECTED_SCRIPT_MARKER)){stackURL=INJECTED_SCRIPT_STRING;let stackFunction=void 0!==getStackTraceURL[1]?getStackTraceURL[1].slice(0,-1):line.slice(0,getStackTraceURL.index).trim();startsWith(stackFunction,\"at\")&&(stackFunction=stackFunction.slice(2).trim()),stack=\"\".concat(stackFunction,\" \").concat(stackURL).trim()}else stack=stackURL}else stack=line;return stack}));if(stackLines)for(let index=0;index<stackLines.length;index+=1){if(isInlineScript(stackMatch)&&documentURL===stackLines[index])return!0;if(isInjectedScript(stackMatch)&&startsWith(stackLines[index],INJECTED_SCRIPT_STRING))return!0}return!1}(stackMatch,stackTrace))return!0;const stackRegexp=function(){let input=arguments.length>0&&void 0!==arguments[0]?arguments[0]:\"\";const FORWARD_SLASH=\"\/\";if(\"\"===input)return new RegExp(\".?\");if(input[0]===FORWARD_SLASH&&input[input.length-1]===FORWARD_SLASH)return new RegExp(input.slice(1,-1));const escaped=input.replace(\/[.*+?^${}()|[\\]\\\\]\/g,\"\\\\$&\");return new RegExp(escaped)}(stackMatch),refinedStackTrace=stackTrace.split(\"\\n\").slice(2).map((function(line){return line.trim()})).join(\"\\n\");return Object.getOwnPropertyDescriptor(RegExp.prototype,\"test\").value.call(stackRegexp,refinedStackTrace)}(stack,(new Error).stack))return;let constantValue;if(\"undefined\"===value)constantValue=void 0;else if(\"false\"===value)constantValue=!1;else if(\"true\"===value)constantValue=!0;else if(\"null\"===value)constantValue=null;else if(\"emptyArr\"===value)constantValue=[];else if(\"emptyObj\"===value)constantValue={};else if(\"noopFunc\"===value)constantValue=noopFunc;else if(\"noopCallbackFunc\"===value)constantValue=noopCallbackFunc;else if(\"trueFunc\"===value)constantValue=trueFunc;else if(\"falseFunc\"===value)constantValue=falseFunc;else if(\"throwFunc\"===value)constantValue=throwFunc;else if(\"noopPromiseResolve\"===value)constantValue=noopPromiseResolve;else if(\"noopPromiseReject\"===value)constantValue=noopPromiseReject;else if(\/^\\d+$\/.test(value)){if(constantValue=parseFloat(value),num=constantValue,(Number.isNaN||window.isNaN)(num))return;if(Math.abs(constantValue)>32767)return}else if(\"-1\"===value)constantValue=-1;else if(\"\"===value)constantValue=\"\";else if(\"yes\"===value)constantValue=\"yes\";else{if(\"no\"!==value)return;constantValue=\"no\"}var num;let canceled=!1;const mustCancel=function(value){return canceled||(canceled=void 0!==value&&void 0!==constantValue&&typeof value!=typeof constantValue&&null!==value,canceled)},trapProp=function(base,prop,configurable,handler){if(!handler.init(base[prop]))return!1;const origDescriptor=Object.getOwnPropertyDescriptor(base,prop);let prevSetter;if(origDescriptor instanceof Object){if(!origDescriptor.configurable){const message=\"Property '\".concat(prop,\"' is not configurable\");return function(source,message){let forced=arguments.length>2&&void 0!==arguments[2]&&arguments[2],convertMessageToString=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const name=source.name,ruleText=source.ruleText,verbose=source.verbose;if(!forced&&!verbose)return;const nativeConsole=console.log;if(!convertMessageToString)return void nativeConsole(\"\".concat(name,\":\"),message);let messageStr=\"\".concat(name,\": \").concat(message);if(ruleText){const RULE_MARKER=\"#%#\/\/scriptlet\",markerIdx=ruleText.indexOf(RULE_MARKER);if(markerIdx>-1){const ruleWithoutDomains=ruleText.slice(markerIdx,ruleText.length);messageStr+=\"; cannot apply rule: \".concat(ruleWithoutDomains)}}nativeConsole(messageStr)}(source,message),!1}base[prop]=constantValue,origDescriptor.set instanceof Function&&(prevSetter=origDescriptor.set)}return Object.defineProperty(base,prop,{configurable:configurable,get:()=>handler.get(),set(a){void 0!==prevSetter&&prevSetter(a),handler.set(a)}}),!0};!function setChainPropAccess(owner,property){const chainInfo=getPropertyInChain(owner,property),base=chainInfo.base,prop=chainInfo.prop,chain=chainInfo.chain,inChainPropHandler={factValue:void 0,init(a){return this.factValue=a,!0},get(){return this.factValue},set(a){this.factValue!==a&&(this.factValue=a,a instanceof Object&&setChainPropAccess(a,chain))}};if(!chain)return void(trapProp(base,prop,!1,{init:a=>!mustCancel(a),get:()=>constantValue,set(a){mustCancel(a)&&(constantValue=a)}})&&function(source){if(!0===source.verbose){try{const log=console.log.bind(console),trace=console.trace.bind(console);let prefix=source.ruleText||\"\";if(source.domainName){const AG_SCRIPTLET_MARKER=\"#%#\/\/\",UBO_SCRIPTLET_MARKER=\"##+js\";let ruleStartIndex;source.ruleText.indexOf(AG_SCRIPTLET_MARKER)>-1?ruleStartIndex=source.ruleText.indexOf(AG_SCRIPTLET_MARKER):source.ruleText.indexOf(UBO_SCRIPTLET_MARKER)>-1&&(ruleStartIndex=source.ruleText.indexOf(UBO_SCRIPTLET_MARKER));const rulePart=source.ruleText.slice(ruleStartIndex);prefix=\"\".concat(source.domainName).concat(rulePart)}log(\"\".concat(prefix,\" trace start\")),trace&&trace(),log(\"\".concat(prefix,\" trace end\"))}catch(e){}\"function\"==typeof window.__debug&&window.__debug(source)}}(source));if(void 0!==base&&null===base[prop])return void trapProp(base,prop,!0,inChainPropHandler);(base instanceof Object||\"object\"==typeof base)&&isEmptyObject(base)&&trapProp(base,prop,!0,inChainPropHandler);const propValue=owner[prop];(propValue instanceof Object||\"object\"==typeof propValue&&null!==propValue)&&setChainPropAccess(propValue,chain),trapProp(base,prop,!0,inChainPropHandler)}(window,property)}).apply(this,updatedArgs)}catch(e){console.log(e)}})({name:\"set-constant\",engine:\"corelibs\",version:\"1.11.86\",verbose:false},[\"google_ad_status\",\"1\",]);\n",nonce:"9859c5bc7fb04f7495091b7dde5",filteringContext:{"isReferrerRuleJsInject":true,"isReferrerRuleElemhide":true},interceptionContext:{"isSubscriptionIntercept":true,"isUserscriptIntercept":false},safeBrowsingUrl:null,verbose:false},ElementUtils=function(){function e(){}return e.elementToString=function(e){var t=[];t.push("<"),t.push(e.localName);for(var r=e.attributes,o=0;o<r.length;o+=1){var s=r[o];t.push(" "),t.push(s.name),t.push('="');var n=null===s.value?"":s.value.replace(/"/g,'\\"');t.push(n),t.push('"')}return t.push(">"),t.join("")},e.appendChildren=function(e,t){var r=e.querySelectorAll("*");if(r&&r.length>0)for(var o=0;o<r.length;o+=1)t.push(r[o])},e.addUnique=function(e,t){if(t.length>0)for(var r=0;r<t.length;r+=1){var o=t[r];-1===e.indexOf(o)&&e.push(o)}},e.removeElements=function(e){for(var t=0;t<e.length;t+=1){e[t].remove()}},e.parseInfo=function(t,r){if(!t||t.indexOf(r)<0)return null;var o=decodeURIComponent(t),s=(o=(o=e.removeQuotes(o)).substring(r.length)).indexOf(";");if(s<0)return null;var n=parseInt(o.substring(0,s),10);return Number.isNaN(n)?null:{filterId:n,ruleText:o.substring(s+1)}},e.parseExtendedStyleInfo=function(t,r){var o=t.lastIndexOf("!important");if(-1===o)return e.parseInfo(t,r);var s=t.substring(0,o).trim();return e.parseInfo(s,r)},e.removeQuotes=function(e){return e.length>1&&('"'===e[0]&&'"'===e[e.length-1]||"'"===e[0]&&"'"===e[e.length-1])?e.substring(1,e.length-1):e},e}(),HitsStorage=function(){function e(){this.counter=0,this.randomKey=e.generateRandomKey(),this.map=new Map}return e.prototype.isCounted=function(e,t){var r=e[this.randomKey];if(r){var o=this.map.get(r);if(o)return o.element===e&&o.rule===t}return!1},e.prototype.setCounted=function(e,t){var r=this.getCounter();e[this.randomKey]=r,this.map.set(r,{element:e,rule:t})},e.prototype.getCounter=function(){return this.counter+=1,this.counter},e.generateRandomKey=function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t="",r=0;r<10;r+=1)t+=e.charAt(Math.floor(Math.random()*e.length));return t},e}(),CssHitsCounter=function(){function e(e){this.hitsStorage=new HitsStorage,this.observer=null,this.countIsWorking=!1,this.onCssHitsFoundCallback=e,"complete"===document.readyState||"interactive"===document.readyState?this.countCssHits():document.addEventListener("readystatechange",this.startCounter.bind(this))}return e.prototype.stop=function(){this.onCssHitsFoundCallback=function(){},this.observer&&this.observer.disconnect()},e.prototype.countAffectedByExtendedCss=function(t){if(t&&t.rules&&t.rules.length>0){for(var r=[],o=0,s=t.rules;o<s.length;o++){var n=s[o];if(n.style&&n.style.content){var i=ElementUtils.parseExtendedStyleInfo(n.style.content,e.CONTENT_ATTR_PREFIX);if(null===i)continue;var l=i.filterId,a=i.ruleText;void 0!==l&&void 0!==a&&(r.push({filterId:l,ruleText:a,element:ElementUtils.elementToString(t.node)}),n.style.content="")}}this.onCssHitsFoundCallback(r)}return t},e.prototype.startCounter=function(){"interactive"!==document.readyState&&"complete"!==document.readyState||(this.countCssHits(),document.removeEventListener("readystatechange",this.startCounter))},e.prototype.countCssHits=function(){this.countAllCssHits(),this.countCssHitsForMutations()},e.prototype.countAllCssHits=function(){var t=this;if(!this.countIsWorking){this.countIsWorking=!0;var r=document.querySelectorAll("*");this.countCssHitsBatch(r,0,e.CSS_HITS_BATCH_SIZE,e.CSS_HITS_BATCH_SIZE,[],(function(e){e.length>0&&t.onCssHitsFoundCallback(e),t.countIsWorking=!1}))}},e.prototype.countCssHitsBatch=function(t,r,o,s,n,i){var l=this,a=Math.min(o,t.length);n=n.concat(this.countCssHitsForElements(t,r,a)),a!==t.length?(r=o,o+=s,window.setTimeout((function(){l.countCssHitsBatch(t,r,o,s,n,i)}),e.COUNT_CSS_HITS_BATCH_DELAY)):i(n)},e.prototype.countCssHitsForElements=function(t,r,o){r=r||0,o=o||t.length;for(var s=[],n=r;n<o;n+=1){var i=t[n],l=e.getCssHitData(i);if(l){var a=l.filterId,E=l.ruleText,c=a+";"+E;this.hitsStorage.isCounted(i,c)||(this.hitsStorage.setCounted(i,c),s.push({filterId:a,ruleText:E,element:ElementUtils.elementToString(i)}))}}return s},e.prototype.countCssHitsForMutations=function(){var t=this,r=window.MutationObserver;if(r){this.observer&&this.observer.disconnect();var o=new WeakSet,s=null;this.observer=new r((function(r){var n=[],i=[],l=[];(r.forEach((function(r){if(0!==r.addedNodes.length)for(var s=0;s<r.addedNodes.length;s+=1){var a=r.addedNodes[s];if(a instanceof Element&&!e.isIgnoredNodeTag(a.tagName)){var E=r.target;if(!a.parentNode&&E){if(o.has(a))return;n.push(a),o.add(a),ElementUtils.appendChildren(a,i),t.observer&&t.observer.disconnect(),r.target.appendChild(a)}else a.parentNode&&E&&(l.push(a),ElementUtils.appendChildren(a,l))}}})),l.length>0&&l.length<=e.CSS_HITS_BATCH_SIZE)&&((a=t.countCssHitsForElements(l,0,null)).length>0&&t.onCssHitsFoundCallback(a));var a,E=[];(ElementUtils.addUnique(E,i),ElementUtils.addUnique(E,n),E.length>0)&&((a=t.countCssHitsForElements(E,0,null)).length>0&&t.onCssHitsFoundCallback(a),ElementUtils.removeElements(n),t.startObserver());s&&window.clearTimeout(s),s=window.setTimeout((function(){t.countAllCssHits(),window.clearTimeout(s)}),e.COUNT_ALL_CSS_HITS_TIMEOUT_MS)})),this.startObserver()}},e.prototype.startObserver=function(){this.observer&&this.observer.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0})},e.getCssHitData=function(t){var r=getComputedStyle(t);return ElementUtils.parseInfo(r.content,e.CONTENT_ATTR_PREFIX)},e.isIgnoredNodeTag=function(e){return["script"].includes(e.toLowerCase())},e.COUNT_CSS_HITS_BATCH_DELAY=5,e.CSS_HITS_BATCH_SIZE=25,e.CONTENT_ATTR_PREFIX="adguard",e.COUNT_ALL_CSS_HITS_TIMEOUT_MS=500,e}(),logError=function(e){"undefined"!=typeof console&&console.error&&(console.error("Error in AdGuard script"),console.error(e))},logDebug=function(){if(configuration.verbose&&"undefined"!=typeof console&&console.error){for(var e,t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];(e=console).debug.apply(e,["[AdGuard content-script]"].concat(r))}};function getCurrentScript(){var e=document.currentScript;if(!e){var t=document.getElementsByTagName("script");e=t[t.length-1]}return e}var currentScript=getCurrentScript(),rootElement=currentScript.parentNode,MO=window.MutationObserver||window.WebKitMutationObserver,ua=navigator.userAgent;-1!==ua.indexOf("MSIE")||ua.indexOf("Trident/");var createPolicy=function createPolicy(){var defaultPolicy={createHTML:function(e){return e},createScript:function(e){return e},createScriptURL:function(e){return e}},isTrustedScriptSupported=function(){try{return!eval(window.trustedTypes.emptyScript)}catch(e){return!1}}();return isTrustedScriptSupported?window.trustedTypes.createPolicy("AGPolicy",defaultPolicy):defaultPolicy},AGPolicy=createPolicy(),NONCE_ATTR_NAME="nonce",TYPE_ATTR_NAME="type",TYPE_ATTR_VALUE="text/css";function protectElementFromRemoval(e){if(MO){var t=e.parentElement,r={childList:!0},o=new MO((function(s){for(var n=0;n<s.length;n++)for(var i=s[n].removedNodes,l=0;l<i.length;l++){if(i[l]===e)return o.disconnect(),t.appendChild(e),void o.observe(t,r)}}));o.observe(t,r)}}function protectChild(e,t){if(MO){var r={childList:!0},o=new MO((function(){o.disconnect(),e.innerHTML="",e.appendChild(t),o.observe(e,r)}));o.observe(e,r)}}function protectTextNodeContent(e){if(MO){var t={characterData:!0,characterDataOldValue:!0},r=new MO((function(o){var s=o[0].oldValue;r.disconnect(),e.nodeValue=s,r.observe(e,t)}));r.observe(e,t)}}function protectElementAttributes(e,t){if(MO){var r=0,o={attributes:!0},s=new MO((function(n){for(var i=0;i<n.length;i++){if(n[i].type)return s.disconnect(),e.setAttribute(TYPE_ATTR_NAME,TYPE_ATTR_VALUE),e.setAttribute(NONCE_ATTR_NAME,t),void((r+=1)<50&&s.observe(e,o))}}));s.observe(e,o)}}var protectStyleElement=function(e,t,r){protectElementAttributes(e,r),protectElementFromRemoval(e),protectChild(e,t),protectTextNodeContent(t)};function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const NODE={SELECTOR_LIST:"SelectorList",SELECTOR:"Selector",REGULAR_SELECTOR:"RegularSelector",EXTENDED_SELECTOR:"ExtendedSelector",ABSOLUTE_PSEUDO_CLASS:"AbsolutePseudoClass",RELATIVE_PSEUDO_CLASS:"RelativePseudoClass"};class AnySelectorNode{constructor(e){_defineProperty(this,"children",[]),this.type=e}addChild(e){this.children.push(e)}}class RegularSelectorNode extends AnySelectorNode{constructor(e){super(NODE.REGULAR_SELECTOR),this.value=e}}class RelativePseudoClassNode extends AnySelectorNode{constructor(e){super(NODE.RELATIVE_PSEUDO_CLASS),this.name=e}}class AbsolutePseudoClassNode extends AnySelectorNode{constructor(e){super(NODE.ABSOLUTE_PSEUDO_CLASS),_defineProperty(this,"value",""),this.name=e}}const LEFT_SQUARE_BRACKET="[",RIGHT_SQUARE_BRACKET="]",LEFT_PARENTHESIS="(",RIGHT_PARENTHESIS=")",LEFT_CURLY_BRACKET="{",RIGHT_CURLY_BRACKET="}",BRACKET={SQUARE:{LEFT:LEFT_SQUARE_BRACKET,RIGHT:RIGHT_SQUARE_BRACKET},PARENTHESES:{LEFT:LEFT_PARENTHESIS,RIGHT:RIGHT_PARENTHESIS},CURLY:{LEFT:LEFT_CURLY_BRACKET,RIGHT:RIGHT_CURLY_BRACKET}},SLASH="/",BACKSLASH="\\",SPACE=" ",COMMA=",",DOT=".",SEMICOLON=";",COLON=":",SINGLE_QUOTE="'",DOUBLE_QUOTE='"',CARET="^",DOLLAR_SIGN="$",EQUAL_SIGN="=",TAB="\t",CARRIAGE_RETURN="\r",LINE_FEED="\n",FORM_FEED="\f",WHITE_SPACE_CHARACTERS=[SPACE,TAB,CARRIAGE_RETURN,LINE_FEED,FORM_FEED],ASTERISK="*",ID_MARKER="#",CLASS_MARKER=DOT,DESCENDANT_COMBINATOR=SPACE,CHILD_COMBINATOR=">",NEXT_SIBLING_COMBINATOR="+",SUBSEQUENT_SIBLING_COMBINATOR="~",COMBINATORS=[DESCENDANT_COMBINATOR,CHILD_COMBINATOR,NEXT_SIBLING_COMBINATOR,SUBSEQUENT_SIBLING_COMBINATOR],SUPPORTED_SELECTOR_MARKS=[LEFT_SQUARE_BRACKET,RIGHT_SQUARE_BRACKET,LEFT_PARENTHESIS,RIGHT_PARENTHESIS,LEFT_CURLY_BRACKET,RIGHT_CURLY_BRACKET,SLASH,BACKSLASH,SEMICOLON,COLON,COMMA,SINGLE_QUOTE,DOUBLE_QUOTE,CARET,DOLLAR_SIGN,ASTERISK,ID_MARKER,CLASS_MARKER,DESCENDANT_COMBINATOR,CHILD_COMBINATOR,NEXT_SIBLING_COMBINATOR,SUBSEQUENT_SIBLING_COMBINATOR,TAB,CARRIAGE_RETURN,LINE_FEED,FORM_FEED],SUPPORTED_STYLE_DECLARATION_MARKS=[COLON,SEMICOLON,SINGLE_QUOTE,DOUBLE_QUOTE,BACKSLASH,SPACE,TAB,CARRIAGE_RETURN,LINE_FEED,FORM_FEED],CONTAINS_PSEUDO="contains",HAS_TEXT_PSEUDO="has-text",ABP_CONTAINS_PSEUDO="-abp-contains",MATCHES_CSS_PSEUDO="matches-css",MATCHES_CSS_BEFORE_PSEUDO="matches-css-before",MATCHES_CSS_AFTER_PSEUDO="matches-css-after",MATCHES_ATTR_PSEUDO_CLASS_MARKER="matches-attr",MATCHES_PROPERTY_PSEUDO_CLASS_MARKER="matches-property",XPATH_PSEUDO_CLASS_MARKER="xpath",NTH_ANCESTOR_PSEUDO_CLASS_MARKER="nth-ancestor",CONTAINS_PSEUDO_NAMES=[CONTAINS_PSEUDO,HAS_TEXT_PSEUDO,ABP_CONTAINS_PSEUDO],UPWARD_PSEUDO_CLASS_MARKER="upward",REMOVE_PSEUDO_MARKER="remove",HAS_PSEUDO_CLASS_MARKER="has",ABP_HAS_PSEUDO_CLASS_MARKER="-abp-has",HAS_PSEUDO_CLASS_MARKERS=[HAS_PSEUDO_CLASS_MARKER,ABP_HAS_PSEUDO_CLASS_MARKER],IS_PSEUDO_CLASS_MARKER="is",NOT_PSEUDO_CLASS_MARKER="not",ABSOLUTE_PSEUDO_CLASSES=[CONTAINS_PSEUDO,HAS_TEXT_PSEUDO,ABP_CONTAINS_PSEUDO,MATCHES_CSS_PSEUDO,MATCHES_CSS_BEFORE_PSEUDO,MATCHES_CSS_AFTER_PSEUDO,MATCHES_ATTR_PSEUDO_CLASS_MARKER,MATCHES_PROPERTY_PSEUDO_CLASS_MARKER,XPATH_PSEUDO_CLASS_MARKER,NTH_ANCESTOR_PSEUDO_CLASS_MARKER,UPWARD_PSEUDO_CLASS_MARKER],RELATIVE_PSEUDO_CLASSES=[...HAS_PSEUDO_CLASS_MARKERS,IS_PSEUDO_CLASS_MARKER,NOT_PSEUDO_CLASS_MARKER],SUPPORTED_PSEUDO_CLASSES=[...ABSOLUTE_PSEUDO_CLASSES,...RELATIVE_PSEUDO_CLASSES],OPTIMIZATION_PSEUDO_CLASSES=[NOT_PSEUDO_CLASS_MARKER,IS_PSEUDO_CLASS_MARKER],SCOPE_CSS_PSEUDO_CLASS=":scope",REGULAR_PSEUDO_ELEMENTS={AFTER:"after",BACKDROP:"backdrop",BEFORE:"before",CUE:"cue",CUE_REGION:"cue-region",FIRST_LETTER:"first-letter",FIRST_LINE:"first-line",FILE_SELECTION_BUTTON:"file-selector-button",GRAMMAR_ERROR:"grammar-error",MARKER:"marker",PART:"part",PLACEHOLDER:"placeholder",SELECTION:"selection",SLOTTED:"slotted",SPELLING_ERROR:"spelling-error",TARGET_TEXT:"target-text"},AT_RULE_MARKER="@",CONTENT_CSS_PROPERTY="content",PSEUDO_PROPERTY_POSITIVE_VALUE="true",DEBUG_PSEUDO_PROPERTY_GLOBAL_VALUE="global",NO_SELECTOR_ERROR_PREFIX="Selector should be defined",STYLE_ERROR_PREFIX={NO_STYLE:"No style declaration found",NO_SELECTOR:`${NO_SELECTOR_ERROR_PREFIX} before style declaration in stylesheet`,INVALID_STYLE:"Invalid style declaration",UNCLOSED_STYLE:"Unclosed style declaration",NO_PROPERTY:"Missing style property in declaration",NO_VALUE:"Missing style value in declaration",NO_STYLE_OR_REMOVE:"Style should be declared or :remove() pseudo-class should used",NO_COMMENT:"Comments are not supported"},NO_AT_RULE_ERROR_PREFIX="At-rules are not supported",REMOVE_ERROR_PREFIX={INVALID_REMOVE:"Invalid :remove() pseudo-class in selector",NO_TARGET_SELECTOR:`${NO_SELECTOR_ERROR_PREFIX} before :remove() pseudo-class`,MULTIPLE_USAGE:"Pseudo-class :remove() appears more than once in selector",INVALID_POSITION:"Pseudo-class :remove() should be at the end of selector"},MATCHING_ELEMENT_ERROR_PREFIX="Error while matching element",MAX_STYLE_PROTECTION_COUNT=50,REGEXP_VALID_OLD_SYNTAX=/\[-(?:ext)-([a-z-_]+)=(["'])((?:(?=(\\?))\4.)*?)\2\]/g,INVALID_OLD_SYNTAX_MARKER="[-ext-",evaluateMatch=(e,t,r,o)=>{const s=new RegExp(`([^\\\\]|^)\\\\${r}`,"g");return`:${t}(${o.replace(s,`$1${r}`)})`},SCOPE_MARKER_REGEXP=/\(:scope >/g,SCOPE_REPLACER="(>",MATCHES_CSS_PSEUDO_ELEMENT_REGEXP=/(:matches-css)-(before|after)\(/g,convertMatchesCss=(e,t,r)=>`${t}${BRACKET.PARENTHESES.LEFT}${r}${COMMA}`,normalize=e=>{const t=e.replace(REGEXP_VALID_OLD_SYNTAX,evaluateMatch).replace(SCOPE_MARKER_REGEXP,SCOPE_REPLACER).replace(MATCHES_CSS_PSEUDO_ELEMENT_REGEXP,convertMatchesCss);if(t.includes(INVALID_OLD_SYNTAX_MARKER))throw new Error(`Invalid extended-css old syntax selector: '${e}'`);return t},convert=e=>{const t=e.trim();return normalize(t)},TOKEN_TYPE={MARK:"mark",WORD:"word"},tokenize=(e,t)=>{let r="";const o=[];return e.split("").forEach((e=>{if(t.includes(e))return r.length>0&&(o.push({type:TOKEN_TYPE.WORD,value:r}),r=""),void o.push({type:TOKEN_TYPE.MARK,value:e});r+=e})),r.length>0&&o.push({type:TOKEN_TYPE.WORD,value:r}),o},tokenizeSelector=e=>{const t=convert(e);return tokenize(t,SUPPORTED_SELECTOR_MARKS)},tokenizeAttribute=e=>tokenize(e,[...SUPPORTED_SELECTOR_MARKS,EQUAL_SIGN]),flatten=e=>{const t=[];e.forEach((e=>t.push(e)));const r=[];for(;t.length;){const e=t.pop();if(!e)throw new Error("Unable to make array flat");Array.isArray(e)?e.forEach((e=>t.push(e))):r.push(e)}return r.reverse()},getFirst=e=>e[0],getLast=e=>e[e.length-1],getPrevToLast=e=>e[e.length-2],getItemByIndex=(e,t,r)=>{const o=e[t];if(!o)throw new Error(r||`No array item found by index ${t}`);return o},NO_REGULAR_SELECTOR_ERROR="At least one of Selector node children should be RegularSelector",isSelectorListNode=e=>(null==e?void 0:e.type)===NODE.SELECTOR_LIST,isSelectorNode=e=>(null==e?void 0:e.type)===NODE.SELECTOR,isRegularSelectorNode=e=>(null==e?void 0:e.type)===NODE.REGULAR_SELECTOR,isExtendedSelectorNode=e=>e.type===NODE.EXTENDED_SELECTOR,isAbsolutePseudoClassNode=e=>(null==e?void 0:e.type)===NODE.ABSOLUTE_PSEUDO_CLASS,isRelativePseudoClassNode=e=>(null==e?void 0:e.type)===NODE.RELATIVE_PSEUDO_CLASS,getNodeName=e=>{if(null===e)throw new Error("Ast node should be defined");if(!isAbsolutePseudoClassNode(e)&&!isRelativePseudoClassNode(e))throw new Error("Only AbsolutePseudoClass or RelativePseudoClass ast node can have a name");if(!e.name)throw new Error("Extended pseudo-class should have a name");return e.name},getNodeValue=(e,t)=>{if(null===e)throw new Error("Ast node should be defined");if(!isRegularSelectorNode(e)&&!isAbsolutePseudoClassNode(e))throw new Error("Only RegularSelector ot AbsolutePseudoClass ast node can have a value");if(!e.value)throw new Error(t||"Ast RegularSelector ot AbsolutePseudoClass node should have a value");return e.value},getRegularSelectorNodes=e=>e.filter(isRegularSelectorNode),getFirstRegularChild=(e,t)=>{const r=getRegularSelectorNodes(e),o=getFirst(r);if(!o)throw new Error(t||NO_REGULAR_SELECTOR_ERROR);return o},getLastRegularChild=e=>{const t=getRegularSelectorNodes(e),r=getLast(t);if(!r)throw new Error(NO_REGULAR_SELECTOR_ERROR);return r},getNodeOnlyChild=(e,t)=>{if(1!==e.children.length)throw new Error(t);const r=getFirst(e.children);if(!r)throw new Error(t);return r},getPseudoClassNode=e=>getNodeOnlyChild(e,"Extended selector should be specified"),getRelativeSelectorListNode=e=>{if(!isRelativePseudoClassNode(e))throw new Error("Only RelativePseudoClass node can have relative SelectorList node as child");return getNodeOnlyChild(e,`Missing arg for :${getNodeName(e)}() pseudo-class`)},ATTRIBUTE_CASE_INSENSITIVE_FLAG="i",POSSIBLE_MARKS_BEFORE_REGEXP={COMMON:[BRACKET.PARENTHESES.LEFT,SINGLE_QUOTE,DOUBLE_QUOTE,EQUAL_SIGN,DOT,COLON,SPACE],CONTAINS:[BRACKET.PARENTHESES.LEFT,SINGLE_QUOTE,DOUBLE_QUOTE]},isSupportedPseudoClass=e=>SUPPORTED_PSEUDO_CLASSES.includes(e),isOptimizationPseudoClass=e=>OPTIMIZATION_PSEUDO_CLASSES.includes(e),doesRegularContinueAfterSpace=(e,t)=>!(!e||!t)&&(COMBINATORS.includes(t)||e===TOKEN_TYPE.WORD||t===ASTERISK||t===ID_MARKER||t===CLASS_MARKER||t===COLON||t===SINGLE_QUOTE||t===DOUBLE_QUOTE||t===BRACKET.SQUARE.LEFT),isRegexpOpening=(e,t,r)=>{const o=getLast(e.extendedPseudoNamesStack);if(!o)throw new Error("Regexp pattern allowed only in arg of extended pseudo-class");if(CONTAINS_PSEUDO_NAMES.includes(o))return POSSIBLE_MARKS_BEFORE_REGEXP.CONTAINS.includes(t);if(t===SLASH&&o!==XPATH_PSEUDO_CLASS_MARKER){throw new Error(`Invalid regexp pattern for :${o}() pseudo-class ${r?`in arg part: '${r}'`:"arg"}`)}return POSSIBLE_MARKS_BEFORE_REGEXP.COMMON.includes(t)},isAttributeOpening=(e,t)=>e===BRACKET.SQUARE.LEFT&&t!==BACKSLASH,isAttributeClosing=e=>{var t;if(!e.isAttributeBracketsOpen)return!1;const r=e.attributeBuffer.split(SPACE).join(""),o=tokenizeAttribute(r),s=getFirst(o),n=null==s?void 0:s.type,i=null==s?void 0:s.value;if(n===TOKEN_TYPE.MARK&&i!==BACKSLASH)throw new Error(`'[${e.attributeBuffer}]' is not a valid attribute due to '${i}' at start of it`);const l=getLast(o),a=null==l?void 0:l.type,E=null==l?void 0:l.value;if(E===EQUAL_SIGN)throw new Error(`'[${e.attributeBuffer}]' is not a valid attribute due to '${EQUAL_SIGN}'`);const c=o.findIndex((e=>e.type===TOKEN_TYPE.MARK&&e.value===EQUAL_SIGN)),u=null===(t=getPrevToLast(o))||void 0===t?void 0:t.value;if(-1===c)return a===TOKEN_TYPE.WORD||u===BACKSLASH&&(E===DOUBLE_QUOTE||E===SINGLE_QUOTE);const d=getItemByIndex(o,c+1).value;if(!(d===SINGLE_QUOTE||d===DOUBLE_QUOTE)){if(a===TOKEN_TYPE.WORD)return!0;throw new Error(`'[${e.attributeBuffer}]' is not a valid attribute`)}return a===TOKEN_TYPE.WORD&&(null==E?void 0:E.toLocaleLowerCase())===ATTRIBUTE_CASE_INSENSITIVE_FLAG?u===d:E===d},isWhiteSpaceChar=e=>!!e&&WHITE_SPACE_CHARACTERS.includes(e),isAbsolutePseudoClass=e=>ABSOLUTE_PSEUDO_CLASSES.includes(e),isRelativePseudoClass=e=>RELATIVE_PSEUDO_CLASSES.includes(e),getBufferNode=e=>0===e.pathToBufferNode.length?null:getLast(e.pathToBufferNode)||null,getBufferNodeParent=e=>e.pathToBufferNode.length<2?null:getPrevToLast(e.pathToBufferNode)||null,getContextLastRegularSelectorNode=e=>{const t=getBufferNode(e);if(!t)throw new Error("No bufferNode found");if(!isSelectorNode(t))throw new Error("Unsupported bufferNode type");const r=getLastRegularChild(t.children);return e.pathToBufferNode.push(r),r},updateBufferNode=(e,t)=>{const r=getBufferNode(e);if(null===r)throw new Error("No bufferNode to update");if(isAbsolutePseudoClassNode(r))r.value+=t;else{if(!isRegularSelectorNode(r))throw new Error(`${r.type} node cannot be updated. Only RegularSelector and AbsolutePseudoClass are supported`);r.value+=t,e.isAttributeBracketsOpen&&(e.attributeBuffer+=t)}},addSelectorListNode=e=>{const t=new AnySelectorNode(NODE.SELECTOR_LIST);e.ast=t,e.pathToBufferNode.push(t)},addAstNodeByType=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"";const o=getBufferNode(e);if(null===o)throw new Error("No buffer node");let s;s=t===NODE.REGULAR_SELECTOR?new RegularSelectorNode(r):t===NODE.ABSOLUTE_PSEUDO_CLASS?new AbsolutePseudoClassNode(r):t===NODE.RELATIVE_PSEUDO_CLASS?new RelativePseudoClassNode(r):new AnySelectorNode(t),o.addChild(s),e.pathToBufferNode.push(s)},initAst=(e,t)=>{addSelectorListNode(e),addAstNodeByType(e,NODE.SELECTOR),addAstNodeByType(e,NODE.REGULAR_SELECTOR,t)},initRelativeSubtree=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";addAstNodeByType(e,NODE.SELECTOR_LIST),addAstNodeByType(e,NODE.SELECTOR),addAstNodeByType(e,NODE.REGULAR_SELECTOR,t)},upToClosest=(e,t)=>{for(let o=e.pathToBufferNode.length-1;o>=0;o-=1){var r;if((null===(r=e.pathToBufferNode[o])||void 0===r?void 0:r.type)===t){e.pathToBufferNode=e.pathToBufferNode.slice(0,o+1);break}}},getUpdatedBufferNode=e=>{const t=getBufferNode(e);if(t&&isSelectorListNode(t)&&isRelativePseudoClassNode(getBufferNodeParent(e)))return t;upToClosest(e,NODE.SELECTOR);const r=getBufferNode(e);if(!r)throw new Error("No SelectorNode, impossible to continue selector parsing by ExtendedCss");const o=getLast(r.children),s=o&&isExtendedSelectorNode(o)&&0===e.standardPseudoBracketsStack.length,n=s&&getFirst(o.children);let i=r;if(n){const t=s&&n.name,r=t&&isRelativePseudoClass(t),l=t&&isAbsolutePseudoClass(t),a=r&&e.extendedPseudoBracketsStack.length>0&&e.extendedPseudoBracketsStack.length===e.extendedPseudoNamesStack.length,E=l&&t===getLast(e.extendedPseudoNamesStack);(a||E)&&(e.pathToBufferNode.push(o),i=n)}else i=s?r:getContextLastRegularSelectorNode(e);return e.pathToBufferNode.push(i),i},handleNextTokenOnColon=(e,t,r,o,s)=>{if(!o)throw new Error(`Invalid colon ':' at the end of selector: '${t}'`);if(isSupportedPseudoClass(o.toLowerCase())){if(HAS_PSEUDO_CLASS_MARKERS.includes(o)&&e.standardPseudoNamesStack.length>0)throw new Error(`Usage of :${o}() pseudo-class is not allowed inside regular pseudo: '${getLast(e.standardPseudoNamesStack)}'`);upToClosest(e,NODE.SELECTOR),addAstNodeByType(e,NODE.EXTENDED_SELECTOR)}else{if(o.toLowerCase()===REMOVE_PSEUDO_MARKER)throw new Error(`${REMOVE_ERROR_PREFIX.INVALID_REMOVE}: '${t}'`);updateBufferNode(e,r),s&&s===BRACKET.PARENTHESES.LEFT&&!e.isAttributeBracketsOpen&&e.standardPseudoNamesStack.push(o)}},IS_OR_NOT_PSEUDO_SELECTING_ROOT=`html ${ASTERISK}`,hasExtendedSelector=e=>e.children.some((e=>e.children.some((e=>isExtendedSelectorNode(e))))),selectorListOfRegularsToString=e=>e.children.map((e=>{const t=getNodeOnlyChild(e,"Ast Selector node should have RegularSelector node");return getNodeValue(t)})).join(`${COMMA}${SPACE}`),updateNodeChildren=(e,t)=>(e.children=t,e),shouldOptimizeExtendedSelector=e=>{if(null===e)return!1;const t=getPseudoClassNode(e),r=getNodeName(t);if(isAbsolutePseudoClass(r))return!1;const o=getRelativeSelectorListNode(t).children;if(isOptimizationPseudoClass(r)){if(o.every((e=>{try{const t=getNodeOnlyChild(e,"Selector node should have RegularSelector");return isRegularSelectorNode(t)}catch(e){return!1}})))return!0}return o.some((e=>e.children.some((e=>!!isExtendedSelectorNode(e)&&shouldOptimizeExtendedSelector(e)))))},getOptimizedExtendedSelector=(e,t)=>{if(!e)return null;const r=getPseudoClassNode(e),o=getRelativeSelectorListNode(r);if(!hasExtendedSelector(o)){const e=selectorListOfRegularsToString(o),s=getNodeName(r),n=`${COLON}${s}${BRACKET.PARENTHESES.LEFT}${e}${BRACKET.PARENTHESES.RIGHT}`;return t.value=`${getNodeValue(t)}${n}`,null}const s=optimizeSelectorListNode(o),n=updateNodeChildren(r,[s]);return updateNodeChildren(e,[n])},optimizeCurrentRegularSelector=(e,t)=>{t.value=`${getNodeValue(t)}${SPACE}${getNodeValue(e)}`},optimizeSelectorNode=e=>{const t=e.children,r=[];let o=0;for(;o<t.length;){const e=getItemByIndex(t,o,"currentChild should be specified");if(0===o)r.push(e);else{const t=getLastRegularChild(r);if(isExtendedSelectorNode(e)){let o=null,s=shouldOptimizeExtendedSelector(e);for(o=e;s;)o=getOptimizedExtendedSelector(o,t),s=shouldOptimizeExtendedSelector(o);if(null!==o){r.push(o);const e=getPseudoClassNode(o),s=getNodeName(e);getNodeValue(t)===ASTERISK&&isOptimizationPseudoClass(s)&&(t.value=IS_OR_NOT_PSEUDO_SELECTING_ROOT)}}else if(isRegularSelectorNode(e)){const o=getLast(r)||null;isRegularSelectorNode(o)&&optimizeCurrentRegularSelector(e,t)}}o+=1}return updateNodeChildren(e,r)},optimizeSelectorListNode=e=>updateNodeChildren(e,e.children.map((e=>optimizeSelectorNode(e)))),optimizeAst=e=>optimizeSelectorListNode(e),XPATH_PSEUDO_SELECTING_ROOT="body",NO_WHITESPACE_ERROR_PREFIX="No white space is allowed before or after extended pseudo-class name in selector",parse=e=>{const t=tokenizeSelector(e),r={ast:null,pathToBufferNode:[],extendedPseudoNamesStack:[],extendedPseudoBracketsStack:[],standardPseudoNamesStack:[],standardPseudoBracketsStack:[],isAttributeBracketsOpen:!1,attributeBuffer:"",isRegexpOpen:!1,shouldOptimize:!1};let o=0;for(;o<t.length;){const s=t[o];if(!s)break;const{type:n,value:i}=s,l=t[o+1],a=null==l?void 0:l.type,E=null==l?void 0:l.value,c=t[o+2],u=null==c?void 0:c.value,d=t[o-1],S=null==d?void 0:d.type,R=null==d?void 0:d.value,p=t[o-2],T=null==p?void 0:p.value;let f=getBufferNode(r);switch(n){case TOKEN_TYPE.WORD:if(null===f)initAst(r,i);else if(isSelectorListNode(f))addAstNodeByType(r,NODE.SELECTOR),addAstNodeByType(r,NODE.REGULAR_SELECTOR,i);else if(isRegularSelectorNode(f))updateBufferNode(r,i);else if(isExtendedSelectorNode(f)){if(isWhiteSpaceChar(E)&&u===BRACKET.PARENTHESES.LEFT)throw new Error(`${NO_WHITESPACE_ERROR_PREFIX}: '${e}'`);const t=i.toLowerCase();r.extendedPseudoNamesStack.push(t),isAbsolutePseudoClass(t)?addAstNodeByType(r,NODE.ABSOLUTE_PSEUDO_CLASS,t):(addAstNodeByType(r,NODE.RELATIVE_PSEUDO_CLASS,t),isOptimizationPseudoClass(t)&&(r.shouldOptimize=!0))}else isAbsolutePseudoClassNode(f)?updateBufferNode(r,i):isRelativePseudoClassNode(f)&&initRelativeSubtree(r,i);break;case TOKEN_TYPE.MARK:switch(i){case COMMA:if(!f||void 0!==f&&!E)throw new Error(`'${e}' is not a valid selector`);isRegularSelectorNode(f)?r.isAttributeBracketsOpen?updateBufferNode(r,i):upToClosest(r,NODE.SELECTOR_LIST):isAbsolutePseudoClassNode(f)?updateBufferNode(r,i):isSelectorNode(f)&&upToClosest(r,NODE.SELECTOR_LIST);break;case SPACE:if(isRegularSelectorNode(f)&&!r.isAttributeBracketsOpen&&(f=getUpdatedBufferNode(r)),isRegularSelectorNode(f)){if(!r.isAttributeBracketsOpen&&(R===COLON&&a===TOKEN_TYPE.WORD||S===TOKEN_TYPE.WORD&&E===BRACKET.PARENTHESES.LEFT))throw new Error(`'${e}' is not a valid selector`);(!E||doesRegularContinueAfterSpace(a,E)||r.isAttributeBracketsOpen)&&updateBufferNode(r,i)}isAbsolutePseudoClassNode(f)&&updateBufferNode(r,i),isRelativePseudoClassNode(f)&&initRelativeSubtree(r),isSelectorNode(f)&&doesRegularContinueAfterSpace(a,E)&&addAstNodeByType(r,NODE.REGULAR_SELECTOR);break;case DESCENDANT_COMBINATOR:case CHILD_COMBINATOR:case NEXT_SIBLING_COMBINATOR:case SUBSEQUENT_SIBLING_COMBINATOR:case SEMICOLON:case SLASH:case BACKSLASH:case SINGLE_QUOTE:case DOUBLE_QUOTE:case CARET:case DOLLAR_SIGN:case BRACKET.CURLY.LEFT:case BRACKET.CURLY.RIGHT:case ASTERISK:case ID_MARKER:case CLASS_MARKER:case BRACKET.SQUARE.LEFT:if(COMBINATORS.includes(i)){if(null===f)throw new Error(`'${e}' is not a valid selector`);f=getUpdatedBufferNode(r)}if(null===f)initAst(r,i),isAttributeOpening(i,R)&&(r.isAttributeBracketsOpen=!0);else if(isRegularSelectorNode(f)){if(i===BRACKET.CURLY.LEFT&&!r.isAttributeBracketsOpen&&!r.isRegexpOpen)throw new Error(`'${e}' is not a valid selector`);updateBufferNode(r,i),isAttributeOpening(i,R)&&(r.isAttributeBracketsOpen=!0)}else isAbsolutePseudoClassNode(f)?(updateBufferNode(r,i),i===SLASH&&r.extendedPseudoNamesStack.length>0&&(R===SLASH&&T===BACKSLASH?r.isRegexpOpen=!1:R&&R!==BACKSLASH&&(isRegexpOpening(r,R,getNodeValue(f))?r.isRegexpOpen=!r.isRegexpOpen:r.isRegexpOpen=!1))):isRelativePseudoClassNode(f)?(initRelativeSubtree(r,i),isAttributeOpening(i,R)&&(r.isAttributeBracketsOpen=!0)):isSelectorNode(f)?COMBINATORS.includes(i)?addAstNodeByType(r,NODE.REGULAR_SELECTOR,i):r.isRegexpOpen||(f=getContextLastRegularSelectorNode(r),updateBufferNode(r,i),isAttributeOpening(i,R)&&(r.isAttributeBracketsOpen=!0)):isSelectorListNode(f)&&(addAstNodeByType(r,NODE.SELECTOR),addAstNodeByType(r,NODE.REGULAR_SELECTOR,i),isAttributeOpening(i,R)&&(r.isAttributeBracketsOpen=!0));break;case BRACKET.SQUARE.RIGHT:if(isRegularSelectorNode(f)){if(!r.isAttributeBracketsOpen&&R!==BACKSLASH)throw new Error(`'${e}' is not a valid selector due to '${i}' after '${getNodeValue(f)}'`);isAttributeClosing(r)&&(r.isAttributeBracketsOpen=!1,r.attributeBuffer=""),updateBufferNode(r,i)}isAbsolutePseudoClassNode(f)&&updateBufferNode(r,i);break;case COLON:if(isWhiteSpaceChar(E)&&u&&SUPPORTED_PSEUDO_CLASSES.includes(u))throw new Error(`${NO_WHITESPACE_ERROR_PREFIX}: '${e}'`);if(null===f){if(E===XPATH_PSEUDO_CLASS_MARKER)initAst(r,XPATH_PSEUDO_SELECTING_ROOT);else{if(E===UPWARD_PSEUDO_CLASS_MARKER||E===NTH_ANCESTOR_PSEUDO_CLASS_MARKER)throw new Error(`${NO_SELECTOR_ERROR_PREFIX} before :${E}() pseudo-class`);initAst(r,ASTERISK)}f=getBufferNode(r)}if(isSelectorListNode(f)&&(addAstNodeByType(r,NODE.SELECTOR),addAstNodeByType(r,NODE.REGULAR_SELECTOR),f=getBufferNode(r)),isRegularSelectorNode(f)&&((R&&COMBINATORS.includes(R)||R===COMMA)&&updateBufferNode(r,ASTERISK),handleNextTokenOnColon(r,e,i,E,u)),isSelectorNode(f)){if(!E)throw new Error(`Invalid colon ':' at the end of selector: '${e}'`);if(isSupportedPseudoClass(E.toLowerCase()))addAstNodeByType(r,NODE.EXTENDED_SELECTOR);else{if(E.toLowerCase()===REMOVE_PSEUDO_MARKER)throw new Error(`${REMOVE_ERROR_PREFIX.INVALID_REMOVE}: '${e}'`);f=getContextLastRegularSelectorNode(r),handleNextTokenOnColon(r,e,i,a,u)}}if(isAbsolutePseudoClassNode(f)){if(getNodeName(f)===XPATH_PSEUDO_CLASS_MARKER&&E&&SUPPORTED_PSEUDO_CLASSES.includes(E)&&u===BRACKET.PARENTHESES.LEFT)throw new Error(`:xpath() pseudo-class should be the last in selector: '${e}'`);updateBufferNode(r,i)}if(isRelativePseudoClassNode(f)){if(!E)throw new Error(`Invalid pseudo-class arg at the end of selector: '${e}'`);initRelativeSubtree(r,ASTERISK),isSupportedPseudoClass(E.toLowerCase())?(upToClosest(r,NODE.SELECTOR),addAstNodeByType(r,NODE.EXTENDED_SELECTOR)):(updateBufferNode(r,i),u===BRACKET.PARENTHESES.LEFT&&r.standardPseudoNamesStack.push(E))}break;case BRACKET.PARENTHESES.LEFT:isAbsolutePseudoClassNode(f)&&(getNodeName(f)!==XPATH_PSEUDO_CLASS_MARKER&&r.isRegexpOpen?updateBufferNode(r,i):(r.extendedPseudoBracketsStack.push(i),r.extendedPseudoBracketsStack.length>r.extendedPseudoNamesStack.length&&updateBufferNode(r,i))),isRegularSelectorNode(f)&&(r.standardPseudoNamesStack.length>0&&(updateBufferNode(r,i),r.standardPseudoBracketsStack.push(i)),r.isAttributeBracketsOpen&&updateBufferNode(r,i)),isRelativePseudoClassNode(f)&&r.extendedPseudoBracketsStack.push(i);break;case BRACKET.PARENTHESES.RIGHT:if(isAbsolutePseudoClassNode(f)&&(getNodeName(f)!==XPATH_PSEUDO_CLASS_MARKER&&r.isRegexpOpen?updateBufferNode(r,i):(r.extendedPseudoBracketsStack.pop(),getNodeName(f)!==XPATH_PSEUDO_CLASS_MARKER?(r.extendedPseudoNamesStack.pop(),r.extendedPseudoBracketsStack.length>r.extendedPseudoNamesStack.length?updateBufferNode(r,i):r.extendedPseudoBracketsStack.length>=0&&r.extendedPseudoNamesStack.length>=0&&upToClosest(r,NODE.SELECTOR)):r.extendedPseudoBracketsStack.length<r.extendedPseudoNamesStack.length?r.extendedPseudoNamesStack.pop():updateBufferNode(r,i))),isRegularSelectorNode(f))if(r.isAttributeBracketsOpen)updateBufferNode(r,i);else if(r.standardPseudoNamesStack.length>0&&r.standardPseudoBracketsStack.length>0){updateBufferNode(r,i),r.standardPseudoBracketsStack.pop();const t=r.standardPseudoNamesStack.pop();if(!t)throw new Error(`Parsing error. Invalid selector: ${e}`);if(Object.values(REGULAR_PSEUDO_ELEMENTS).includes(t)&&E===COLON&&u&&HAS_PSEUDO_CLASS_MARKERS.includes(u))throw new Error(`Usage of :${u}() pseudo-class is not allowed after any regular pseudo-element: '${t}'`)}else r.extendedPseudoBracketsStack.pop(),r.extendedPseudoNamesStack.pop(),upToClosest(r,NODE.EXTENDED_SELECTOR),upToClosest(r,NODE.SELECTOR);isSelectorNode(f)&&(r.extendedPseudoBracketsStack.pop(),r.extendedPseudoNamesStack.pop(),upToClosest(r,NODE.EXTENDED_SELECTOR),upToClosest(r,NODE.SELECTOR)),isRelativePseudoClassNode(f)&&r.extendedPseudoNamesStack.length>0&&r.extendedPseudoBracketsStack.length>0&&(r.extendedPseudoBracketsStack.pop(),r.extendedPseudoNamesStack.pop());break;case LINE_FEED:case FORM_FEED:case CARRIAGE_RETURN:throw new Error(`'${e}' is not a valid selector`);case TAB:if(!isRegularSelectorNode(f)||!r.isAttributeBracketsOpen)throw new Error(`'${e}' is not a valid selector`);updateBufferNode(r,i)}break;default:throw new Error(`Unknown type of token: '${i}'`)}o+=1}if(null===r.ast)throw new Error(`'${e}' is not a valid selector`);if(r.extendedPseudoNamesStack.length>0||r.extendedPseudoBracketsStack.length>0)throw new Error(`Unbalanced brackets for extended pseudo-class: '${getLast(r.extendedPseudoNamesStack)}'`);if(r.isAttributeBracketsOpen)throw new Error(`Unbalanced attribute brackets in selector: '${e}'`);return r.shouldOptimize?optimizeAst(r.ast):r.ast},natives={MutationObserver:window.MutationObserver||window.WebKitMutationObserver};class NativeTextContent{constructor(){this.nativeNode=window.Node||Node}setGetter(){var e;this.getter=null===(e=Object.getOwnPropertyDescriptor(this.nativeNode.prototype,"textContent"))||void 0===e?void 0:e.get}}const nativeTextContent=new NativeTextContent,getNodeTextContent=e=>nativeTextContent.getter?nativeTextContent.getter.apply(e):e.textContent||"",getElementSelectorDesc=e=>{let t=e.tagName.toLowerCase();return t+=Array.from(e.attributes).map((t=>`[${t.name}="${e.getAttribute(t.name)}"]`)).join(""),t},getElementSelectorPath=e=>{if(!(e instanceof Element))throw new Error("Function received argument with wrong type");let t;t=e;const r=[];for(;t&&t.nodeType===Node.ELEMENT_NODE;){let e=t.nodeName.toLowerCase();if(t.id&&"string"==typeof t.id){e+=`#${t.id}`,r.unshift(e);break}let o=t,s=1;for(;o.previousElementSibling;)o=o.previousElementSibling,o.nodeType===Node.ELEMENT_NODE&&o.nodeName.toLowerCase()===e&&(s+=1);1!==s&&(e+=`:nth-of-type(${s})`),r.unshift(e),t=t.parentElement}return r.join(" > ")},isHtmlElement=e=>e instanceof HTMLElement,getParent=(e,t)=>{const{parentElement:r}=e;if(!r)throw new Error(t||"Element does no have parent element");return r},isErrorWithMessage=e=>"object"==typeof e&&null!==e&&"message"in e&&"string"==typeof e.message,toErrorWithMessage=e=>{if(isErrorWithMessage(e))return e;try{return new Error(JSON.stringify(e))}catch{return new Error(String(e))}},getErrorMessage=e=>toErrorWithMessage(e).message,logger={error:"undefined"!=typeof console&&console.error&&console.error.bind?console.error.bind(window.console):console.error,info:"undefined"!=typeof console&&console.info&&console.info.bind?console.info.bind(window.console):console.info},removeSuffix=(e,t)=>{const r=e.indexOf(t,e.length-t.length);return r>=0?e.substring(0,r):e},replaceAll=(e,t,r)=>e?e.split(t).join(r):e,toRegExp=e=>{if(e.startsWith(SLASH)&&e.endsWith(SLASH))return new RegExp(e.slice(1,-1));const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(t)},convertTypeIntoString=e=>{let t;switch(e){case void 0:t="undefined";break;case null:t="null";break;default:t=e.toString()}return t},convertTypeFromString=e=>{const t=Number(e);let r;if(Number.isNaN(t))switch(e){case"undefined":r=void 0;break;case"null":r=null;break;case"true":r=!0;break;case"false":r=!1;break;default:r=e}else r=t;return r},SAFARI_USER_AGENT_REGEXP=/\sVersion\/(\d{2}\.\d)(.+\s|\s)(Safari)\//,isSafariBrowser=SAFARI_USER_AGENT_REGEXP.test(navigator.userAgent),isUserAgentSupported=e=>!e.includes("MSIE")&&!e.includes("Trident/"),isBrowserSupported=()=>isUserAgentSupported(navigator.userAgent),CSS_PROPERTY={BACKGROUND:"background",BACKGROUND_IMAGE:"background-image",CONTENT:"content",OPACITY:"opacity"},REGEXP_ANY_SYMBOL=".*",REGEXP_WITH_FLAGS_REGEXP=/^\s*\/.*\/[gmisuy]*\s*$/,removeContentQuotes=e=>e.replace(/^(["'])([\s\S]*)\1$/,"$2"),addUrlPropertyQuotes=e=>{if(!e.includes('url("')){const t=/url\((.*?)\)/g;return e.replace(t,'url("$1")')}return e},addUrlQuotesTo={regexpArg:e=>e.replace(/(\^)?url(\\)?\\\((\w|\[\w)/g,'$1url$2\\(\\"?$3'),noneRegexpArg:addUrlPropertyQuotes},escapeRegExp=e=>{const t=new RegExp(`[${[".","+","?","$","{","}","(",")","[","]","\\","/"].join("\\")}]`,"g");return e.replace(t,"\\$&")},convertStyleMatchValueToRegexp=e=>{let t;return e.startsWith(SLASH)&&e.endsWith(SLASH)?(t=addUrlQuotesTo.regexpArg(e),t=t.slice(1,-1)):(t=addUrlQuotesTo.noneRegexpArg(e),t=t.replace(/\\([\\()[\]"])/g,"$1"),t=escapeRegExp(t),t=replaceAll(t,ASTERISK,REGEXP_ANY_SYMBOL)),new RegExp(t,"i")},normalizePropertyValue=(e,t)=>{let r="";switch(e){case CSS_PROPERTY.BACKGROUND:case CSS_PROPERTY.BACKGROUND_IMAGE:r=addUrlPropertyQuotes(t);break;case CSS_PROPERTY.CONTENT:r=removeContentQuotes(t);break;case CSS_PROPERTY.OPACITY:r=isSafariBrowser?(Math.round(100*parseFloat(t))/100).toString():t;break;default:r=t}return r},getComputedStylePropertyValue=(e,t,r)=>{const o=window.getComputedStyle(e,r).getPropertyValue(t);return normalizePropertyValue(t,o)},getPseudoArgData=(e,t)=>{const r=e.indexOf(t);let o,s;return r>-1?(o=e.substring(0,r).trim(),s=e.substring(r+1).trim()):o=e,{name:o,value:s}},parseStyleMatchArg=(e,t)=>{const{name:r,value:o}=getPseudoArgData(t,COMMA);let s=r,n=o;if(Object.values(REGULAR_PSEUDO_ELEMENTS).includes(r)||(s=null,n=t),!n)throw new Error(`Required style property argument part is missing in :${e}() arg: '${t}'`);return s&&(s=`${COLON}${COLON}${s}`),{regularPseudoElement:s,styleMatchArg:n}},isStyleMatched=e=>{const{pseudoName:t,pseudoArg:r,domElement:o}=e,{regularPseudoElement:s,styleMatchArg:n}=parseStyleMatchArg(t,r),{name:i,value:l}=getPseudoArgData(n,COLON);if(!i||!l)throw new Error(`Required property name or value is missing in :${t}() arg: '${n}'`);let a;try{a=convertStyleMatchValueToRegexp(l)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`Invalid argument of :${t}() pseudo-class: '${n}'`)}const E=getComputedStylePropertyValue(o,i,s);return a&&a.test(E)},validateStrMatcherArg=e=>!e.includes(SLASH)&&!!/^[\w-]+$/.test(e),getValidMatcherArg=function(e){let t,r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.length>1&&e.startsWith(DOUBLE_QUOTE)&&e.endsWith(DOUBLE_QUOTE)&&(e=e.slice(1,-1)),""===e)throw new Error("Argument should be specified. Empty arg is invalid.");if(e.startsWith(SLASH)&&e.endsWith(SLASH)){if(!(e.length>2))throw new Error(`Invalid regexp: '${e}'`);t=toRegExp(e)}else if(e.includes(ASTERISK)){if(e===ASTERISK&&!r)throw new Error(`Argument should be more specific than ${e}`);t=replaceAll(e,ASTERISK,REGEXP_ANY_SYMBOL),t=new RegExp(t)}else{if(!validateStrMatcherArg(e))throw new Error(`Invalid argument: '${e}'`);t=e}return t},getRawMatchingData=(e,t)=>{const{name:r,value:o}=getPseudoArgData(t,EQUAL_SIGN);if(!r)throw new Error(`Required attribute name is missing in :${e} arg: ${t}`);return{rawName:r,rawValue:o}},isAttributeMatched=e=>{const{pseudoName:t,pseudoArg:r,domElement:o}=e,s=o.attributes;if(0===s.length)return!1;const{rawName:n,rawValue:i}=getRawMatchingData(t,r);let l;try{l=getValidMatcherArg(n)}catch(e){const t=getErrorMessage(e);throw logger.error(t),new SyntaxError(t)}let a=!1,E=0;for(;E<s.length&&!a;){const e=s[E];if(!e)break;const t=l instanceof RegExp?l.test(e.name):l===e.name;if(i){let r;try{r=getValidMatcherArg(i)}catch(e){const t=getErrorMessage(e);throw logger.error(t),new SyntaxError(t)}const o=r instanceof RegExp?r.test(e.value):r===e.value;a=t&&o}else a=t;E+=1}return a},parseRawPropChain=e=>{e.length>1&&e.startsWith(DOUBLE_QUOTE)&&e.endsWith(DOUBLE_QUOTE)&&(e=e.slice(1,-1));const t=e.split(DOT),r=[];let o="",s=!1,n=0;for(;n<t.length;){const i=getItemByIndex(t,n,`Invalid pseudo-class arg: '${e}'`);i.startsWith(SLASH)&&i.endsWith(SLASH)&&i.length>2?r.push(i):i.startsWith(SLASH)?(s=!0,o+=i):i.endsWith(SLASH)?(s=!1,o+=`.${i}`,r.push(o),o=""):s?o+=i:r.push(i),n+=1}if(o.length>0)throw new Error(`Invalid regexp property pattern '${e}'`);return r.map((t=>{if(0===t.length)throw new Error(`Empty pattern '${t}' is invalid in chain '${e}'`);let r;try{r=getValidMatcherArg(t,!0)}catch(r){throw logger.error(getErrorMessage(r)),new Error(`Invalid property pattern '${t}' in property chain '${e}'`)}return r}))},filterRootsByRegexpChain=function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const o=getFirst(t);if(1===t.length){let t;for(t in e)o instanceof RegExp?o.test(t)&&r.push({base:e,prop:t,value:e[t]}):o===t&&r.push({base:e,prop:o,value:e[t]});return r}if(o instanceof RegExp){const s=t.slice(1),n=[];for(const t in e)o.test(t)&&n.push(t);n.forEach((t=>{var o;const n=null===(o=Object.getOwnPropertyDescriptor(e,t))||void 0===o?void 0:o.value;filterRootsByRegexpChain(n,s,r)}))}if(e&&"string"==typeof o){var s;const n=null===(s=Object.getOwnPropertyDescriptor(e,o))||void 0===s?void 0:s.value;t=t.slice(1),void 0!==n&&filterRootsByRegexpChain(n,t,r)}return r},isPropertyMatched=e=>{const{pseudoName:t,pseudoArg:r,domElement:o}=e,{rawName:s,rawValue:n}=getRawMatchingData(t,r);if(s.includes("\\/")||s.includes("\\."))throw new Error(`Invalid :${t} name pattern: ${s}`);let i;try{i=parseRawPropChain(s)}catch(e){const t=getErrorMessage(e);throw logger.error(t),new SyntaxError(t)}const l=filterRootsByRegexpChain(o,i);if(0===l.length)return!1;let a=!0;if(n){let e;try{e=getValidMatcherArg(n)}catch(e){const t=getErrorMessage(e);throw logger.error(t),new SyntaxError(t)}if(e)for(let t=0;t<l.length;t+=1){var E;const r=null===(E=l[t])||void 0===E?void 0:E.value;if(e instanceof RegExp)a=e.test(convertTypeIntoString(r));else{if("null"===r||"undefined"===r){a=e===r;break}a=convertTypeFromString(e)===r}if(a)break}}return a},isTextMatched=e=>{const{pseudoName:t,pseudoArg:r,domElement:o}=e,s=getNodeTextContent(o);let n,i=r;if(i.startsWith(SLASH)&&REGEXP_WITH_FLAGS_REGEXP.test(i)){const e=i.lastIndexOf("/"),o=i.substring(e+1);let l;i=i.substring(0,e+1).slice(1,-1).replace(/\\([\\"])/g,"$1");try{l=new RegExp(i,o)}catch(e){throw new Error(`Invalid argument of :${t}() pseudo-class: ${r}`)}n=l.test(s)}else i=i.replace(/\\([\\()[\]"])/g,"$1"),n=s.includes(i);return n},getValidNumberAncestorArg=(e,t)=>{const r=Number(e);if(Number.isNaN(r)||r<1||r>=256)throw new Error(`Invalid argument of :${t} pseudo-class: '${e}'`);return r},getNthAncestor=(e,t,r)=>{let o=null,s=0;for(;s<t;){if(o=e.parentElement,!o)throw new Error(`Out of DOM: Argument of :${r}() pseudo-class is too big — '${t}'.`);e=o,s+=1}return o},validateStandardSelector=e=>{let t;try{document.querySelectorAll(e),t=!0}catch(e){t=!1}return t},matcherWrapper=(e,t,r)=>{let o;try{o=e(t)}catch(e){throw logger.error(getErrorMessage(e)),new Error(r)}return o},getAbsolutePseudoError=(e,t,r)=>`${MATCHING_ELEMENT_ERROR_PREFIX} ${e}, may be invalid :${t}() pseudo-class arg: '${r}'`,isMatchedByAbsolutePseudo=(e,t,r)=>{let o,s,n;switch(t){case CONTAINS_PSEUDO:case HAS_TEXT_PSEUDO:case ABP_CONTAINS_PSEUDO:n=isTextMatched,o={pseudoName:t,pseudoArg:r,domElement:e},s=getAbsolutePseudoError("text content",t,r);break;case MATCHES_CSS_PSEUDO:case MATCHES_CSS_AFTER_PSEUDO:case MATCHES_CSS_BEFORE_PSEUDO:n=isStyleMatched,o={pseudoName:t,pseudoArg:r,domElement:e},s=getAbsolutePseudoError("style",t,r);break;case MATCHES_ATTR_PSEUDO_CLASS_MARKER:n=isAttributeMatched,o={domElement:e,pseudoName:t,pseudoArg:r},s=getAbsolutePseudoError("attributes",t,r);break;case MATCHES_PROPERTY_PSEUDO_CLASS_MARKER:n=isPropertyMatched,o={domElement:e,pseudoName:t,pseudoArg:r},s=getAbsolutePseudoError("properties",t,r);break;default:throw new Error(`Unknown absolute pseudo-class :${t}()`)}return matcherWrapper(n,o,s)},findByAbsolutePseudoPseudo={nthAncestor:(e,t,r)=>{const o=getValidNumberAncestorArg(t,r);return e.map((e=>{let t=null;try{t=getNthAncestor(e,o,r)}catch(e){logger.error(getErrorMessage(e))}return t})).filter(isHtmlElement)},xpath:(e,t)=>{const r=e.map((e=>{const r=[];let o;try{o=document.evaluate(t,e,null,window.XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`Invalid argument of :xpath() pseudo-class: '${t}'`)}let s=o.iterateNext();for(;s;)isHtmlElement(s)&&r.push(s),s=o.iterateNext();return r}));return flatten(r)},upward:(e,t)=>{if(!validateStandardSelector(t))throw new Error(`Invalid argument of :upward pseudo-class: '${t}'`);return e.map((e=>{const r=e.parentElement;return r?r.closest(t):null})).filter(isHtmlElement)}},scopeDirectChildren=`${SCOPE_CSS_PSEUDO_CLASS}${CHILD_COMBINATOR}`,scopeAnyChildren=`${SCOPE_CSS_PSEUDO_CLASS}${DESCENDANT_COMBINATOR}`,getFirstInnerRegularChild=(e,t)=>getFirstRegularChild(e.children,`RegularSelector is missing for :${t}() pseudo-class`),hasRelativesBySelectorList=e=>{const{element:t,relativeSelectorList:r,pseudoName:o}=e;return r.children.every((e=>{const r=getFirstInnerRegularChild(e,o);let s="",n=null;const i=getNodeValue(r);if(i.startsWith(NEXT_SIBLING_COMBINATOR)||i.startsWith(SUBSEQUENT_SIBLING_COMBINATOR)){n=t.parentElement;const e=getElementSelectorDesc(t);s=`${scopeDirectChildren}${e}${i}`}else i===ASTERISK?(n=t,s=`${scopeAnyChildren}${ASTERISK}`):(s=`${scopeAnyChildren}${i}`,n=t);if(!n)throw new Error(`Selection by :${o}() pseudo-class is not possible`);let l;try{l=getElementsForSelectorNode(e,n,s)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`Invalid selector for :${o}() pseudo-class: '${i}'`)}return l.length>0}))},isAnyElementBySelectorList=e=>{const{element:t,relativeSelectorList:r,pseudoName:o}=e;return r.children.some((e=>{const r=getFirstInnerRegularChild(e,o),s=getParent(t,`Selection by :${o}() pseudo-class is not possible`),n=`${scopeDirectChildren}${getNodeValue(r)}`;let i;try{i=getElementsForSelectorNode(e,s,n)}catch(e){return!1}return i.includes(t)}))},notElementBySelectorList=e=>{const{element:t,relativeSelectorList:r,pseudoName:o}=e;return r.children.every((e=>{const r=getFirstInnerRegularChild(e,o),s=getParent(t,`Selection by :${o}() pseudo-class is not possible`),n=`${scopeDirectChildren}${getNodeValue(r)}`;let i;try{i=getElementsForSelectorNode(e,s,n)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`Invalid selector for :${o}() pseudo-class: '${getNodeValue(r)}'`)}return!i.includes(t)}))},getByRegularSelector=(e,t,r)=>{const o=r||getNodeValue(e);let s=[];try{s=Array.from(t.querySelectorAll(o))}catch(e){throw new Error(`Error: unable to select by '${o}' — ${getErrorMessage(e)}`)}return s},getByExtendedSelector=(e,t)=>{let r=[];const o=getPseudoClassNode(t),s=getNodeName(o);if(isAbsolutePseudoClass(s)){const t=getNodeValue(o,`Missing arg for :${s}() pseudo-class`);if(s===NTH_ANCESTOR_PSEUDO_CLASS_MARKER)r=findByAbsolutePseudoPseudo.nthAncestor(e,t,s);else if(s===XPATH_PSEUDO_CLASS_MARKER){try{document.createExpression(t,null)}catch(e){throw new Error(`Invalid argument of :${s}() pseudo-class: '${t}'`)}r=findByAbsolutePseudoPseudo.xpath(e,t)}else r=s===UPWARD_PSEUDO_CLASS_MARKER?Number.isNaN(Number(t))?findByAbsolutePseudoPseudo.upward(e,t):findByAbsolutePseudoPseudo.nthAncestor(e,t,s):e.filter((e=>isMatchedByAbsolutePseudo(e,s,t)))}else{if(!isRelativePseudoClass(s))throw new Error(`Unknown extended pseudo-class: '${s}'`);{const t=getRelativeSelectorListNode(o);let n;switch(s){case HAS_PSEUDO_CLASS_MARKER:case ABP_HAS_PSEUDO_CLASS_MARKER:n=e=>hasRelativesBySelectorList({element:e,relativeSelectorList:t,pseudoName:s});break;case IS_PSEUDO_CLASS_MARKER:n=e=>isAnyElementBySelectorList({element:e,relativeSelectorList:t,pseudoName:s});break;case NOT_PSEUDO_CLASS_MARKER:n=e=>notElementBySelectorList({element:e,relativeSelectorList:t,pseudoName:s});break;default:throw new Error(`Unknown relative pseudo-class: '${s}'`)}r=e.filter(n)}}return r},getByFollowingRegularSelector=(e,t)=>{let r=[];const o=getNodeValue(t);return r=o.startsWith(CHILD_COMBINATOR)?e.map((e=>getByRegularSelector(t,e,`${SCOPE_CSS_PSEUDO_CLASS}${o}`))):o.startsWith(NEXT_SIBLING_COMBINATOR)||o.startsWith(SUBSEQUENT_SIBLING_COMBINATOR)?e.map((e=>{const r=e.parentElement;if(!r)return[];const s=getElementSelectorDesc(e);return getByRegularSelector(t,r,`${scopeDirectChildren}${s}${o}`)})):e.map((e=>{const r=`${scopeAnyChildren}${getNodeValue(t)}`;return getByRegularSelector(t,e,r)})),flatten(r)},getElementsForSelectorNode=(e,t,r)=>{let o=[],s=0;for(;s<e.children.length;){const n=getItemByIndex(e.children,s,"selectorNodeChild should be specified");0===s?o=getByRegularSelector(n,t,r):isExtendedSelectorNode(n)?o=getByExtendedSelector(o,n):isRegularSelectorNode(n)&&(o=getByFollowingRegularSelector(o,n)),s+=1}return o},selectElementsByAst=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;const r=[];e.children.forEach((e=>{r.push(...getElementsForSelectorNode(e,t))}));const o=[...new Set(flatten(r))];return o};class ExtCssDocument{constructor(){this.astCache=new Map}saveAstToCache(e,t){this.astCache.set(e,t)}getAstFromCache(e){return this.astCache.get(e)||null}getSelectorAst(e){let t=this.getAstFromCache(e);return t||(t=parse(e)),this.saveAstToCache(e,t),t}querySelectorAll(e){const t=this.getSelectorAst(e);return selectElementsByAst(t)}}const extCssDocument=new ExtCssDocument,getObjectFromEntries=e=>{const t={};return e.forEach((e=>{const[r,o]=e;t[r]=o})),t},DEBUG_PSEUDO_PROPERTY_KEY="debug",parseRemoveSelector=e=>{const t=`${COLON}${REMOVE_PSEUDO_MARKER}${BRACKET.PARENTHESES.LEFT}${BRACKET.PARENTHESES.RIGHT}`,r=`${COLON}${REMOVE_PSEUDO_MARKER}${BRACKET.PARENTHESES.LEFT}`;let o,s=!1;const n=e.indexOf(t);if(0===n)throw new Error(`${REMOVE_ERROR_PREFIX.NO_TARGET_SELECTOR}: '${e}'`);if(n>0){if(n!==e.lastIndexOf(t))throw new Error(`${REMOVE_ERROR_PREFIX.MULTIPLE_USAGE}: '${e}'`);if(n+t.length<e.length)throw new Error(`${REMOVE_ERROR_PREFIX.INVALID_POSITION}: '${e}'`);o=e.substring(0,n),s=!0}else{if(e.includes(r))throw new Error(`${REMOVE_ERROR_PREFIX.INVALID_REMOVE}: '${e}'`);o=e}return{selector:o,stylesOfSelector:s?[{property:REMOVE_PSEUDO_MARKER,value:PSEUDO_PROPERTY_POSITIVE_VALUE}]:[]}},parseSelectorRulePart=(e,t)=>{let r,o=e.trim();if(o.startsWith(AT_RULE_MARKER))throw new Error(`${NO_AT_RULE_ERROR_PREFIX}: '${o}'.`);try{r=parseRemoveSelector(o)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`${REMOVE_ERROR_PREFIX.INVALID_REMOVE}: '${o}'`)}let s,n=[],i=!1;try{o=r.selector,n=r.stylesOfSelector,s=t.getSelectorAst(o),i=!0}catch(e){i=!1}return{success:i,selector:o,ast:s,stylesOfSelector:n}},createRawResultsMap=()=>new Map,saveToRawResults=(e,t)=>{const{selector:r,ast:o,rawStyles:s}=t;if(!s)throw new Error(`No style declaration for selector: '${r}'`);if(!o)throw new Error(`No ast parsed for selector: '${r}'`);const n=e.get(r);n?n.styles.push(...s):e.set(r,{ast:o,styles:s})},isRemoveSetInStyles=e=>e.some((e=>e.property===REMOVE_PSEUDO_MARKER&&e.value===PSEUDO_PROPERTY_POSITIVE_VALUE)),getDebugStyleValue=e=>{const t=e.find((e=>e.property===DEBUG_PSEUDO_PROPERTY_KEY));return null==t?void 0:t.value},prepareRuleData=e=>{const{selector:t,ast:r,rawStyles:o}=e;if(!r)throw new Error(`AST should be parsed for selector: '${t}'`);if(!o)throw new Error(`Styles should be parsed for selector: '${t}'`);const s={selector:t,ast:r},n=getDebugStyleValue(o),i=isRemoveSetInStyles(o);let l=o;if(n&&(l=o.filter((e=>e.property!==DEBUG_PSEUDO_PROPERTY_KEY)),n!==PSEUDO_PROPERTY_POSITIVE_VALUE&&n!==DEBUG_PSEUDO_PROPERTY_GLOBAL_VALUE||(s.debug=n)),i){s.style={[REMOVE_PSEUDO_MARKER]:PSEUDO_PROPERTY_POSITIVE_VALUE};const e=l.find((e=>e.property===CONTENT_CSS_PROPERTY));e&&(s.style[CONTENT_CSS_PROPERTY]=e.value)}else if(l.length>0){const e=l.map((e=>{const{property:t,value:r}=e;return[t,r]})),t=getObjectFromEntries(e);s.style=t}return s},combineRulesData=e=>{const t=[];return e.forEach(((e,r)=>{const o=r,{ast:s,styles:n}=e;t.push(prepareRuleData({selector:o,ast:s,rawStyles:n}))})),t},tokenizeStyleBlock=e=>{const t=e.trim();return tokenize(t,SUPPORTED_STYLE_DECLARATION_MARKS)},DECLARATION_PART={PROPERTY:"property",VALUE:"value"},isValueQuotesOpen=e=>""!==e.bufferValue&&null!==e.valueQuoteMark,collectStyle=e=>{e.styles.push({property:e.bufferProperty.trim(),value:e.bufferValue.trim()}),e.bufferProperty="",e.bufferValue=""},processPropertyToken=(e,t,r)=>{const{value:o}=r;switch(r.type){case TOKEN_TYPE.WORD:if(e.bufferProperty.length>0)throw new Error(`Invalid style property in style block: '${t}'`);e.bufferProperty+=o;break;case TOKEN_TYPE.MARK:if(o===COLON){if(0===e.bufferProperty.trim().length)throw new Error(`Missing style property before ':' in style block: '${t}'`);e.bufferProperty=e.bufferProperty.trim(),e.processing=DECLARATION_PART.VALUE}else if(!WHITE_SPACE_CHARACTERS.includes(o))throw new Error(`Invalid style declaration in style block: '${t}'`);break;default:throw new Error(`Unsupported style property character: '${o}' in style block: '${t}'`)}},processValueToken=(e,t,r)=>{const{value:o}=r;if(r.type===TOKEN_TYPE.WORD)e.bufferValue+=o;else switch(o){case COLON:if(!isValueQuotesOpen(e))throw new Error(`Invalid style value for property '${e.bufferProperty}' in style block: '${t}'`);e.bufferValue+=o;break;case SEMICOLON:isValueQuotesOpen(e)?e.bufferValue+=o:(collectStyle(e),e.processing=DECLARATION_PART.PROPERTY);break;case SINGLE_QUOTE:case DOUBLE_QUOTE:null===e.valueQuoteMark?e.valueQuoteMark=o:e.bufferValue.endsWith(BACKSLASH)||e.valueQuoteMark!==o||(e.valueQuoteMark=null),e.bufferValue+=o;break;case BACKSLASH:if(!isValueQuotesOpen(e))throw new Error(`Invalid style value for property '${e.bufferProperty}' in style block: '${t}'`);e.bufferValue+=o;break;case SPACE:case TAB:case CARRIAGE_RETURN:case LINE_FEED:case FORM_FEED:e.bufferValue.length>0&&(e.bufferValue+=o);break;default:throw new Error(`Unknown style declaration token: '${o}'`)}},parseStyleBlock=e=>{const t=e.trim(),r=tokenizeStyleBlock(t),o={processing:DECLARATION_PART.PROPERTY,styles:[],bufferProperty:"",bufferValue:"",valueQuoteMark:null};let s=0;for(;s<r.length;){const e=r[s];if(!e)break;if(o.processing===DECLARATION_PART.PROPERTY)processPropertyToken(o,t,e);else{if(o.processing!==DECLARATION_PART.VALUE)throw new Error("Style declaration parsing failed");processValueToken(o,t,e)}s+=1}if(isValueQuotesOpen(o))throw new Error(`Unbalanced style declaration quotes in style block: '${t}'`);if(o.bufferProperty.length>0){if(0===o.bufferValue.length)throw new Error(`Missing style value for property '${o.bufferProperty}' in style block '${t}'`);collectStyle(o)}if(0===o.styles.length)throw new Error(STYLE_ERROR_PREFIX.NO_STYLE);return o.styles},getLeftCurlyBracketIndexes=e=>{const t=[];for(let r=0;r<e.length;r+=1)e[r]===BRACKET.CURLY.LEFT&&t.push(r);return t},parseRule=(e,t)=>{var r;const o=e.trim();if(o.includes(`${SLASH}${ASTERISK}`)&&o.includes(`${ASTERISK}${SLASH}`))throw new Error(STYLE_ERROR_PREFIX.NO_COMMENT);const s=getLeftCurlyBracketIndexes(o);if(0===getFirst(s))throw new Error(NO_SELECTOR_ERROR_PREFIX);let n,i,l;if(s.length>0&&!o.includes(BRACKET.CURLY.RIGHT))throw new Error(`${STYLE_ERROR_PREFIX.NO_STYLE} OR ${STYLE_ERROR_PREFIX.UNCLOSED_STYLE}`);if(0===s.length||!o.includes(BRACKET.CURLY.RIGHT))try{if(n=parseSelectorRulePart(o,t),n.success){var a;if(0===(null===(a=n.stylesOfSelector)||void 0===a?void 0:a.length))throw new Error(STYLE_ERROR_PREFIX.NO_STYLE_OR_REMOVE);return{selector:n.selector.trim(),ast:n.ast,rawStyles:n.stylesOfSelector}}throw new Error("Invalid selector")}catch(e){throw new Error(getErrorMessage(e))}const E={selector:""};for(let e=s.length-1;e>-1;e-=1){const r=s[e];if(!r)throw new Error(`Impossible to continue, no '{' to process for rule: '${o}'`);if(i=o.slice(0,r),l=o.slice(r+1,o.length-1),n=parseSelectorRulePart(i,t),n.success){var c;E.selector=n.selector.trim(),E.ast=n.ast,E.rawStyles=n.stylesOfSelector;const e=parseStyleBlock(l);null===(c=E.rawStyles)||void 0===c||c.push(...e);break}}if(0===(null===(r=E.selector)||void 0===r?void 0:r.length))throw new Error("Selector in not valid");return E},parseRules=(e,t)=>{const r=createRawResultsMap(),o=[];return[...new Set(e.map((e=>e.trim())))].forEach((e=>{try{saveToRawResults(r,parseRule(e,t))}catch(t){const r=getErrorMessage(t);o.push(`'${e}' - error: '${r}'`)}})),o.length>0&&logger.info(`Invalid rules:\n  ${o.join("\n  ")}`),combineRulesData(r)},REGEXP_DECLARATION_END=/[;}]/g,REGEXP_DECLARATION_DIVIDER=/[;:}]/g,REGEXP_NON_WHITESPACE=/\S/g,restoreRuleAcc=e=>{e.rawRuleData={selector:""}},parseSelectorPart=(e,t)=>{let r,o=e.selectorBuffer.trim();if(o.startsWith(AT_RULE_MARKER))throw new Error(`${NO_AT_RULE_ERROR_PREFIX}: '${o}'.`);try{r=parseRemoveSelector(o)}catch(e){throw logger.error(getErrorMessage(e)),new Error(`${REMOVE_ERROR_PREFIX.INVALID_REMOVE}: '${o}'`)}if(-1===e.nextIndex){if(o===r.selector)throw new Error(`${STYLE_ERROR_PREFIX.NO_STYLE_OR_REMOVE}: '${e.cssToParse}'`);e.cssToParse=""}let s,n=[],i=!1;try{o=r.selector,n=r.stylesOfSelector,s=t.getSelectorAst(o),i=!0}catch(e){i=!1}return e.nextIndex>0&&(e.cssToParse=e.cssToParse.slice(e.nextIndex)),{success:i,selector:o,ast:s,stylesOfSelector:n}},parseUntilClosingBracket=(e,t)=>{REGEXP_DECLARATION_DIVIDER.lastIndex=e.nextIndex;let r=REGEXP_DECLARATION_DIVIDER.exec(e.cssToParse);if(null===r)throw new Error(`${STYLE_ERROR_PREFIX.INVALID_STYLE}: '${e.cssToParse}'`);let o=r.index,s=r[0];if(s===BRACKET.CURLY.RIGHT){if(0!==e.cssToParse.slice(e.nextIndex,o).trim().length)throw new Error(`${STYLE_ERROR_PREFIX.INVALID_STYLE}: '${e.cssToParse}'`);if(0===t.length)throw new Error(`${STYLE_ERROR_PREFIX.NO_STYLE}: '${e.cssToParse}'`);return o}if(s===COLON){const n=o;if(REGEXP_DECLARATION_END.lastIndex=n,r=REGEXP_DECLARATION_END.exec(e.cssToParse),null===r)throw new Error(`${STYLE_ERROR_PREFIX.UNCLOSED_STYLE}: '${e.cssToParse}'`);o=r.index,s=r[0];const i=e.cssToParse.slice(e.nextIndex,n).trim();if(0===i.length)throw new Error(`${STYLE_ERROR_PREFIX.NO_PROPERTY}: '${e.cssToParse}'`);const l=e.cssToParse.slice(n+1,o).trim();if(0===l.length)throw new Error(`${STYLE_ERROR_PREFIX.NO_VALUE}: '${e.cssToParse}'`);if(t.push({property:i,value:l}),s===BRACKET.CURLY.RIGHT)return o}return e.cssToParse=e.cssToParse.slice(o+1),e.nextIndex=0,parseUntilClosingBracket(e,t)},parseNextStyle=e=>{const t=[],r=parseUntilClosingBracket(e,t);REGEXP_NON_WHITESPACE.lastIndex=r+1;const o=REGEXP_NON_WHITESPACE.exec(e.cssToParse);if(null===o)return e.cssToParse="",t;const s=o.index;return e.cssToParse=e.cssToParse.slice(s),t},parseStylesheet=(e,t)=>{const r=e.trim();if(r.includes(`${SLASH}${ASTERISK}`)&&r.includes(`${ASTERISK}${SLASH}`))throw new Error(`${STYLE_ERROR_PREFIX.NO_COMMENT} in stylesheet: '${r}'`);const o={isSelector:!0,nextIndex:0,cssToParse:r,selectorBuffer:"",rawRuleData:{selector:""}},s=createRawResultsMap();let n;for(;o.cssToParse;)if(o.isSelector){if(o.nextIndex=o.cssToParse.indexOf(BRACKET.CURLY.LEFT),0===o.selectorBuffer.length&&0===o.nextIndex)throw new Error(`${STYLE_ERROR_PREFIX.NO_SELECTOR}: '${o.cssToParse}'`);-1===o.nextIndex?o.selectorBuffer=o.cssToParse:o.selectorBuffer+=o.cssToParse.slice(0,o.nextIndex),n=parseSelectorPart(o,t),n.success?(o.rawRuleData.selector=n.selector.trim(),o.rawRuleData.ast=n.ast,o.rawRuleData.rawStyles=n.stylesOfSelector,o.isSelector=!1,-1===o.nextIndex?(saveToRawResults(s,o.rawRuleData),restoreRuleAcc(o)):(o.nextIndex=1,o.selectorBuffer="")):(o.selectorBuffer+=BRACKET.CURLY.LEFT,o.cssToParse=o.cssToParse.slice(1))}else{var i;const e=parseNextStyle(o);null===(i=o.rawRuleData.rawStyles)||void 0===i||i.push(...e),saveToRawResults(s,o.rawRuleData),o.nextIndex=0,restoreRuleAcc(o),o.isSelector=!0}return combineRulesData(s)},isNumber=e=>"number"==typeof e&&!Number.isNaN(e),isSupported=void 0!==window.requestAnimationFrame,timeout=isSupported?requestAnimationFrame:window.setTimeout,deleteTimeout=isSupported?cancelAnimationFrame:clearTimeout,perf=isSupported?performance:Date,DEFAULT_THROTTLE_DELAY_MS=150;class ThrottleWrapper{constructor(e,t,r){this.context=e,this.callback=t,this.throttleDelayMs=r||DEFAULT_THROTTLE_DELAY_MS,this.wrappedCb=this.wrappedCallback.bind(this)}wrappedCallback(e){this.lastRunTime=isNumber(e)?e:perf.now(),this.timeoutId&&(deleteTimeout(this.timeoutId),delete this.timeoutId),clearTimeout(this.timerId),delete this.timerId,this.callback&&this.callback(this.context)}hasPendingCallback(){return isNumber(this.timeoutId)||isNumber(this.timerId)}run(){if(!this.hasPendingCallback()){if(void 0!==this.lastRunTime){const e=perf.now()-this.lastRunTime;if(e<this.throttleDelayMs)return void(this.timerId=window.setTimeout(this.wrappedCb,this.throttleDelayMs-e))}this.timeoutId=timeout(this.wrappedCb)}}static now(){return perf.now()}}const LAST_EVENT_TIMEOUT_MS=10,IGNORED_EVENTS=["mouseover","mouseleave","mouseenter","mouseout"],SUPPORTED_EVENTS=["keydown","keypress","keyup","auxclick","click","contextmenu","dblclick","mousedown","mouseenter","mouseleave","mousemove","mouseover","mouseout","mouseup","pointerlockchange","pointerlockerror","select","wheel"],SAFARI_PROBLEMATIC_EVENTS=["wheel"];class EventTracker{constructor(){_defineProperty(this,"getLastEventType",(()=>this.lastEventType)),_defineProperty(this,"getTimeSinceLastEvent",(()=>this.lastEventTime?Date.now()-this.lastEventTime:null)),this.trackedEvents=isSafariBrowser?SUPPORTED_EVENTS.filter((e=>!SAFARI_PROBLEMATIC_EVENTS.includes(e))):SUPPORTED_EVENTS,this.trackedEvents.forEach((e=>{document.documentElement.addEventListener(e,this.trackEvent,!0)}))}trackEvent(e){this.lastEventType=e.type,this.lastEventTime=Date.now()}isIgnoredEventType(){const e=this.getLastEventType(),t=this.getTimeSinceLastEvent();return!!e&&IGNORED_EVENTS.includes(e)&&!!t&&t<LAST_EVENT_TIMEOUT_MS}stopTracking(){this.trackedEvents.forEach((e=>{document.documentElement.removeEventListener(e,this.trackEvent,!0)}))}}const isEventListenerSupported=void 0!==window.addEventListener,observeDocument=(e,t)=>{natives.MutationObserver?(e.domMutationObserver=new natives.MutationObserver((r=>{if(!r||0===r.length)return;const o=new EventTracker;o.isIgnoredEventType()&&(e=>e.every((e=>"attributes"===e.type)))(r)||(e.eventTracker=o,t())})),e.domMutationObserver.observe(document,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["id","class"]})):isEventListenerSupported&&(document.addEventListener("DOMNodeInserted",t,!1),document.addEventListener("DOMNodeRemoved",t,!1),document.addEventListener("DOMAttrModified",t,!1))},disconnectDocument=(e,t)=>{var r;e.domMutationObserver?e.domMutationObserver.disconnect():isEventListenerSupported&&(document.removeEventListener("DOMNodeInserted",t,!1),document.removeEventListener("DOMNodeRemoved",t,!1),document.removeEventListener("DOMAttrModified",t,!1)),null===(r=e.eventTracker)||void 0===r||r.stopTracking()},mainObserve=(e,t)=>{e.isDomObserved||(e.isDomObserved=!0,observeDocument(e,t))},mainDisconnect=(e,t)=>{e.isDomObserved&&(e.isDomObserved=!1,disconnectDocument(e,t))},CONTENT_ATTR_PREFIX_REGEXP=/^("|')adguard.+?/,removeElement=(e,t)=>{const{node:r}=t;t.removed=!0;const o=getElementSelectorPath(r),s=e.removalsStatistic[o]||0;s>MAX_STYLE_PROTECTION_COUNT?logger.error(`ExtendedCss: infinite loop protection for selector: '${o}'`):r.parentElement&&(r.parentElement.removeChild(r),e.removalsStatistic[o]=s+1)},setStyleToElement=(e,t)=>{e instanceof HTMLElement&&Object.keys(t).forEach((r=>{if(void 0!==e.style.getPropertyValue(r.toString())){let o=t[r];if(!o)return;if(r===CONTENT_CSS_PROPERTY&&o.match(CONTENT_ATTR_PREFIX_REGEXP))return;o=removeSuffix(o.trim(),"!important").trim(),e.style.setProperty(r,o,"important")}}))},isIAffectedElement=e=>"node"in e&&"rules"in e&&e.rules instanceof Array,isAffectedElement=e=>"node"in e&&"originalStyle"in e&&"rules"in e&&e.rules instanceof Array,applyStyle=(e,t)=>{if(t.protectionObserver)return;let r;if(e.beforeStyleApplied){if(!isIAffectedElement(t))throw new Error("Returned IAffectedElement should have 'node' and 'rules' properties");if(r=e.beforeStyleApplied(t),!r)throw new Error("Callback 'beforeStyleApplied' should return IAffectedElement")}else r=t;if(!isAffectedElement(r))throw new Error("Returned IAffectedElement should have 'node' and 'rules' properties");const{node:o,rules:s}=r;for(let t=0;t<s.length;t+=1){const n=s[t],i=null==n?void 0:n.selector,l=null==n?void 0:n.style,a=null==n?void 0:n.debug;if(l){if(l[REMOVE_PSEUDO_MARKER]===PSEUDO_PROPERTY_POSITIVE_VALUE)return void removeElement(e,r);setStyleToElement(o,l)}else if(!a)throw new Error(`No style declaration in rule for selector: '${i}'`)}},revertStyle=e=>{e.protectionObserver&&e.protectionObserver.disconnect(),e.node.style.cssText=e.originalStyle};class ExtMutationObserver{constructor(e){this.styleProtectionCount=0,this.observer=new natives.MutationObserver((t=>{t.length&&(this.styleProtectionCount+=1,e(t,this))}))}observe(e,t){this.styleProtectionCount<MAX_STYLE_PROTECTION_COUNT?this.observer.observe(e,t):logger.error("ExtendedCss: infinite loop protection for style")}disconnect(){this.observer.disconnect()}}const PROTECTION_OBSERVER_OPTIONS={attributes:!0,attributeOldValue:!0,attributeFilter:["style"]},createProtectionCallback=e=>(t,r)=>{if(!t[0])return;const{target:o}=t[0];r.disconnect(),e.forEach((e=>{setStyleToElement(o,e)})),r.observe(o,PROTECTION_OBSERVER_OPTIONS)},protectStyleAttribute=(e,t)=>{if(!natives.MutationObserver)return null;const r=[];t.forEach((e=>{const{style:t}=e;t&&r.push(t)}));const o=new ExtMutationObserver(createProtectionCallback(r));return o.observe(e,PROTECTION_OBSERVER_OPTIONS),o},STATS_DECIMAL_DIGITS_COUNT=4;class TimingStats{constructor(){this.appliesTimings=[],this.appliesCount=0,this.timingsSum=0,this.meanTiming=0,this.squaredSum=0,this.standardDeviation=0}push(e){this.appliesTimings.push(e),this.appliesCount+=1,this.timingsSum+=e,this.meanTiming=this.timingsSum/this.appliesCount,this.squaredSum+=e*e,this.standardDeviation=Math.sqrt(this.squaredSum/this.appliesCount-Math.pow(this.meanTiming,2))}}const beautifyTimingNumber=e=>Number(e.toFixed(STATS_DECIMAL_DIGITS_COUNT)),beautifyTimings=e=>({appliesTimings:e.appliesTimings.map((e=>beautifyTimingNumber(e))),appliesCount:beautifyTimingNumber(e.appliesCount),timingsSum:beautifyTimingNumber(e.timingsSum),meanTiming:beautifyTimingNumber(e.meanTiming),standardDeviation:beautifyTimingNumber(e.standardDeviation)}),printTimingInfo=e=>{if(e.areTimingsPrinted)return;e.areTimingsPrinted=!0;const t={};e.parsedRules.forEach((e=>{if(e.timingStats){const{selector:r,style:o,debug:s,matchedElements:n}=e;if(!o&&!s)throw new Error(`Rule should have style declaration for selector: '${r}'`);const i={selectorParsed:r,timings:beautifyTimings(e.timingStats)};o&&o[REMOVE_PSEUDO_MARKER]===PSEUDO_PROPERTY_POSITIVE_VALUE?i.removed=!0:(i.styleApplied=o||null,i.matchedElements=n),t[r]=i}})),0!==Object.keys(t).length&&logger.info("[ExtendedCss] Timings in milliseconds for %o:\n%o",window.location.href,t)},findAffectedElement=(e,t)=>e.find((e=>e.node===t)),applyRule=(e,t)=>{const r=!!t.debug||e.debug;let o;r&&(o=ThrottleWrapper.now());const{ast:s}=t,n=[];try{n.push(...selectElementsByAst(s))}catch(t){e.debug&&logger.error(getErrorMessage(t))}if(n.forEach((r=>{let o=findAffectedElement(e.affectedElements,r);if(o)o.rules.push(t),applyStyle(e,o);else{const s=r.style.cssText;o={node:r,rules:[t],originalStyle:s,protectionObserver:null},applyStyle(e,o),e.affectedElements.push(o)}})),r&&o){const e=ThrottleWrapper.now()-o;t.timingStats||(t.timingStats=new TimingStats),t.timingStats.push(e)}return n},applyRules=e=>{const t=[];mainDisconnect(e,e.mainCallback),e.parsedRules.forEach((r=>{const o=applyRule(e,r);Array.prototype.push.apply(t,o),r.debug&&(r.matchedElements=o)}));let r=e.affectedElements.length;for(;r;){const o=e.affectedElements[r-1];if(!o)break;t.includes(o.node)?o.removed||o.protectionObserver||(o.protectionObserver=protectStyleAttribute(o.node,o.rules)):(revertStyle(o),e.affectedElements.splice(r-1,1)),r-=1}mainObserve(e,e.mainCallback),printTimingInfo(e)},APPLY_RULES_DELAY=150;class ExtendedCss{constructor(e){if(isBrowserSupported()||logger.error("Browser is not supported by ExtendedCss"),!e)throw new Error("ExtendedCss configuration should be provided.");if(this.context={beforeStyleApplied:e.beforeStyleApplied,debug:!1,affectedElements:[],isDomObserved:!1,removalsStatistic:{},parsedRules:[],mainCallback:()=>{}},!e.styleSheet&&!e.cssRules)throw new Error("ExtendedCss configuration should have 'styleSheet' or 'cssRules' defined.");if(e.styleSheet)try{this.context.parsedRules.push(...parseStylesheet(e.styleSheet,extCssDocument))}catch(e){throw new Error(`Pass the rules as configuration.cssRules since configuration.styleSheet cannot be parsed because of: '${getErrorMessage(e)}'`)}if(e.cssRules&&this.context.parsedRules.push(...parseRules(e.cssRules,extCssDocument)),this.context.debug=e.debug||this.context.parsedRules.some((e=>e.debug===DEBUG_PSEUDO_PROPERTY_GLOBAL_VALUE)),this.applyRulesScheduler=new ThrottleWrapper(this.context,applyRules,APPLY_RULES_DELAY),this.context.mainCallback=this.applyRulesScheduler.run.bind(this.applyRulesScheduler),this.context.beforeStyleApplied&&"function"!=typeof this.context.beforeStyleApplied)throw new Error(`Invalid configuration. Type of 'beforeStyleApplied' should be a function, received: '${typeof this.context.beforeStyleApplied}'`);this.applyRulesCallbackListener=()=>{applyRules(this.context)}}init(){nativeTextContent.setGetter()}apply(){applyRules(this.context),"complete"!==document.readyState&&document.addEventListener("DOMContentLoaded",this.applyRulesCallbackListener,!1)}dispose(){mainDisconnect(this.context,this.context.mainCallback),this.context.affectedElements.forEach((e=>{revertStyle(e)})),document.removeEventListener("DOMContentLoaded",this.applyRulesCallbackListener,!1)}getAffectedElements(){return this.context.affectedElements}static query(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("string"!=typeof e)throw new Error("Selector should be defined as a string.");const r=ThrottleWrapper.now();try{return extCssDocument.querySelectorAll(e)}finally{const e=ThrottleWrapper.now();t||logger.info(`[ExtendedCss] Elapsed: ${Math.round(1e3*(e-r))} μs.`)}}static validate(e){try{const{selector:t}=parseRemoveSelector(e);return ExtendedCss.query(t),{ok:!0,error:null}}catch(t){return{ok:!1,error:`Error: Invalid selector: '${e}' -- ${getErrorMessage(t)}`}}}}var cssHitsCounter=null,getCssHitsCounter=function(e){return e?(cssHitsCounter||(cssHitsCounter=new CssHitsCounter((function(e){logDebug(JSON.stringify(e))}))),cssHitsCounter):null};function returnFalse(){return!1}var disabledDescriptor={get:returnFalse,set:returnFalse},applyCssText=function(e,t){if(e){var r=document.createElement("style");r.setAttribute(TYPE_ATTR_NAME,TYPE_ATTR_VALUE),t&&r.setAttribute(NONCE_ATTR_NAME,t);var o=document.createTextNode(e);r.appendChild(o);var s=currentScript;currentScript.parentNode!=rootElement&&(s=null),rootElement.insertBefore(r,s),Object.defineProperty(r,"disabled",disabledDescriptor),Object.defineProperty(r.sheet,"disabled",disabledDescriptor),protectStyleElement(r,o,t)}},applyCss=function(e,t){if(getCssHitsCounter(configuration.verbose),e instanceof Array)for(var r=e.length;r--;)applyCssText(e[r],t);else applyCssText(e,t)},applyExtendedCss=function(e){if(e){var t={cssRules:e},r=getCssHitsCounter(configuration.verbose);r&&(t.beforeStyleApplied=r.countAffectedByExtendedCss.bind(r)),new ExtendedCss(t).apply()}},applyScript=function applyScript(scriptText){if(scriptText)try{eval(AGPolicy.createScript(scriptText))}catch(e){logError(e)}},isNonRawUserscriptLink=function(e){return[/github\.com\/[^/]+\/[^/]+\/blob\//,/bitbucket\.org\/[^/]+\/[^/]+\/src\//,/gitlab\.com\/.+\/-\/blob\//].some((function(t){return t.test(e)}))};function getClosestAnchor(e){if(e instanceof Node){for(var t=e;t&&!(t instanceof HTMLAnchorElement);)t=t.parentNode;return t}}function detectSubscriptionIfNeeded(e,t){try{if(!e)return;if("http:"===t.protocol||"https:"===t.protocol){if("subscribe.adblockplus.org"!==t.host||"/"!==t.pathname)return}else if(!t.href||-1===t.href.indexOf("abp:subscribe"))return;return t.search?"adguard:subscribe"+t.search:t.href.replace("abp:subscribe","adguard:subscribe")}catch(e){logError(e)}}function detectUserscriptIfNeeded(e,t){try{if(!e)return;if("http:"!==t.protocol&&"https:"!==t.protocol||-1===t.pathname.indexOf(".user.js")||!t.pathname.endsWith(".user.js")||isNonRawUserscriptLink(t.href))return;var r=t.href;return t.search&&(r=r.replace(t.search,"")),"adguard:userscript?location="+r}catch(e){logError(e)}}function onClick(e,t){try{if(2===t.button)return;var r=getClosestAnchor(t.target);if(!r)return;var o=detectSubscriptionIfNeeded(e.isSubscriptionIntercept,r);if(o)return void(r.href=o);var s=detectUserscriptIfNeeded(e.isUserscriptIntercept,r);if(s)return void(r.href=s)}catch(e){logError(e)}}var interceptRequests=function(e){document.documentMode<10||document.addEventListener("click",(function(t){onClick(e,t)}))},checkSafeBrowsing=function(e){if(e){-1!=e.indexOf("?")?e+="&":e+="?",e+="u=",e+=encodeURIComponent(window.location.href),e+="&r=",e+=Math.random();var t=document.createElement("script");t.setAttribute("defer",""),t.setAttribute("src",AGPolicy.createScriptURL(e)),t.setAttribute("type","text/javascript"),t.onload=t.onerror=function(){t.parentNode&&t.parentNode.removeChild(t)},rootElement.appendChild(t)}},isApplyCommonCss=!0,isApplyCss=!0,isApplyScript=!0,CSS_EXCEPTIONS=["mail.yahoo.com","map.baidu.com","ditu.baidu.com"],SAFEBROWSING_EXCEPTIONS=["muve.pl","app.print.avery.com"],isCssException=-1!==CSS_EXCEPTIONS.indexOf(document.location.hostname),isSafeBrowsingException=-1!==SAFEBROWSING_EXCEPTIONS.indexOf(document.location.hostname);if(window!==window.top){var width=Math.max(document.documentElement.clientWidth,window.innerWidth||0),height=Math.max(document.documentElement.clientHeight,window.innerHeight||0);isApplyCommonCss=height*width>1e5,configuration.filteringContext&&Object.prototype.hasOwnProperty.call(configuration.filteringContext,"isReferrerRuleElemhide")&&Object.prototype.hasOwnProperty.call(configuration.filteringContext,"isReferrerRuleJsInject")&&(isApplyCss=configuration.filteringContext.isReferrerRuleElemhide,isApplyScript=configuration.filteringContext.isReferrerRuleJsInject)}var contentScriptExecutionFlagToCheck=configuration.nonce||"adgRunId",runContentScript=function(){document[contentScriptExecutionFlagToCheck]||(document[contentScriptExecutionFlagToCheck]=!0,isApplyCss&&(isCssException||(isApplyCommonCss&&configuration.commonCss&&applyCss(configuration.commonCss,configuration.nonce),applyCss(configuration.specificCss,configuration.nonce)),applyExtendedCss(configuration.extendedCssRules)),isApplyScript&&applyScript(configuration.script),(configuration.interceptionContext.isSubscriptionIntercept||configuration.interceptionContext.isUserscriptIntercept)&&interceptRequests(configuration.interceptionContext),isSafeBrowsingException||checkSafeBrowsing(configuration.safeBrowsingUrl))},cleanUp=function(){delete configuration.commonCss,delete configuration.specificCss,delete configuration.extendedCssRules,delete configuration.script,delete configuration.filteringContext,delete configuration.safeBrowsingUrl,rootElement.removeChild(currentScript)},init=function(){runContentScript(),cleanUp()};init()})();
})();
